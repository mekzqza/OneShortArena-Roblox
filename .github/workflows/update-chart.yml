name: Update Mermaid Chart

on:
  push:
    branches: [ main, master, dev ]
    paths:
      - 'docs/deps.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-chart:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Create Puppeteer Config
        run: |
          echo '{"args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]}' > puppeteer-config.json

      - name: Verify deps.md exists
        run: |
          echo "üìÑ Checking docs/deps.md..."
          if [ ! -f docs/deps.md ]; then
            echo "‚ùå ERROR: docs/deps.md not found!"
            exit 1
          fi
          echo "‚úÖ File exists"
          echo "---FILE PREVIEW---"
          head -20 docs/deps.md
          echo "---END PREVIEW---"

      - name: Generate SVG from Mermaid
        run: |
          echo "üé® Generating SVG from Mermaid diagram..."
          
          # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î output ‡∏Å‡πà‡∏≠‡∏ô
          rm -f *.svg *.png docs/*.svg.tmp 2>/dev/null || true
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á SVG (‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ deps.svg ‡∏´‡∏£‡∏∑‡∏≠ deps-1.svg)
          mmdc -i docs/deps.md -o deps.svg -e svg -p puppeteer-config.json -b transparent -w 1920 -H 1080 || {
            echo "‚ùå mmdc command failed with exit code $?"
            exit 1
          }
          
          echo "üìÅ Listing generated files..."
          ls -la *.svg 2>/dev/null || echo "No SVG files in root"
          ls -la docs/*.svg 2>/dev/null || echo "No SVG files in docs/"
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå SVG ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
          SVG_FILE=""
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
          if [ -f "deps.svg" ]; then
            SVG_FILE="deps.svg"
            echo "‚úÖ Found: deps.svg"
          elif [ -f "deps-1.svg" ]; then
            SVG_FILE="deps-1.svg"
            echo "‚úÖ Found: deps-1.svg"
          elif [ -f "docs/deps.svg" ]; then
            SVG_FILE="docs/deps.svg"
            echo "‚úÖ Found: docs/deps.svg (already in place)"
          elif [ -f "docs/deps-1.svg" ]; then
            SVG_FILE="docs/deps-1.svg"
            echo "‚úÖ Found: docs/deps-1.svg"
          else
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå SVG ‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ "deps" ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠
            SVG_FILE=$(find . -maxdepth 2 -name "*deps*.svg" -type f | head -1)
            if [ -n "$SVG_FILE" ]; then
              echo "‚úÖ Found SVG via fallback search: $SVG_FILE"
            else
              echo "‚ùå ERROR: No SVG file generated!"
              echo "üìÅ Searching for any SVG files:"
              find . -name "*.svg" -type f
              exit 1
            fi
          fi
          
          # ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          if [ "$SVG_FILE" != "docs/deps.svg" ]; then
            echo "üì¶ Moving $SVG_FILE to docs/deps.svg"
            mv "$SVG_FILE" docs/deps.svg
          fi
          
          # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
          echo "üßπ Cleaning up temporary files..."
          rm -f *.svg *.png puppeteer-config.json 2>/dev/null || true
          rm -f docs/*-[0-9].svg 2>/dev/null || true
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
          if [ -f "docs/deps.svg" ]; then
            echo "‚úÖ SUCCESS: docs/deps.svg created!"
            ls -lh docs/deps.svg
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
            SIZE=$(du -h docs/deps.svg | cut -f1)
            echo "üìä File size: $SIZE"
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô SVG ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if head -1 docs/deps.svg | grep -q "<?xml\|<svg"; then
              echo "‚úÖ Valid SVG file detected"
            else
              echo "‚ö†Ô∏è WARNING: File may not be a valid SVG"
              head -5 docs/deps.svg
            fi
          else
            echo "‚ùå ERROR: Final file docs/deps.svg not found!"
            exit 1
          fi

      - name: Commit and Push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
          git add docs/deps.svg
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "üé® Auto-update Mermaid diagram (SVG) [skip ci]"
            
            echo "üöÄ Pushing to repository..."
            git push
            
            echo "‚úÖ Changes pushed successfully!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}