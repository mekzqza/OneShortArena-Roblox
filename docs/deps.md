# 🏗️ OneShortArena - สถาปัตยกรรมระบบ

## 🎯 เข้าใจง่ายใน 1 นาที

```
🎮 เกมนี้ทำงานยังไง?

╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║   👦 ผู้เล่น กดปุ่ม "Play"                                     ║
║      │                                                        ║
║      ▼                                                        ║
║   📱 มือถือ/คอม ส่งข้อความไป Server                           ║
║      │                                                        ║
║      ▼                                                        ║
║   🔒 Server ตรวจสอบ "ส่งบ่อยไปมั้ย? โกงมั้ย?"                 ║
║      │                                                        ║
║      ▼                                                        ║
║   ✅ OK! ย้ายผู้เล่นไป Arena!                                  ║
║      │                                                        ║
║      ▼                                                        ║
║   ⚔️ สู้กัน! ตาย! วนใหม่!                                     ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
```

---

## 📊 Version Info

| ส่วน | เวอร์ชัน | สถานะ |
|------|---------|-------|
| **สถาปัตยกรรม** | 3.1 | ✅ พร้อมใช้งานจริง |
| **ความปลอดภัย** | P0 Fixed | ✅ แก้ไขแล้ว |
| **DeathService** | 2.1 | ✅ ตรวจจับการตาย |
| **MatchService** | 1.0 | ✅ จัดการแมตช์ |

---

## 🖼️ ภาพรวมระบบ (แบบง่ายๆ)

```
┌─────────────────────────────────────────────────────────────────┐
│                     🎮 OneShortArena                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐        ┌──────────────────┐              │
│  │                  │        │                  │              │
│  │   📱 CLIENT      │◄──────►│   🖥️ SERVER      │              │
│  │   (ผู้เล่น)       │ Network │   (เจ้าของเกม)   │              │
│  │                  │        │                  │              │
│  └──────────────────┘        └──────────────────┘              │
│                                                                 │
│  Client ทำอะไร?              Server ทำอะไร?                     │
│  ─────────────               ────────────────                   │
│  • กดปุ่ม                    • ตรวจสอบโกง                       │
│  • แสดงผล                    • ย้ายผู้เล่น                       │
│  • ส่งคำสั่ง                  • นับแต้ม                         │
│                              • จัดการแมตช์                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🏠 โครงสร้างไฟล์ (บ้านของโค้ด)

```
📂 OneShortArena-Roblox/
│
├── 📂 src/ (โค้ดหลัก)
│   │
│   ├── 📂 Client (ฝั่งผู้เล่น) 📱
│   │   ├── 🎮 InputController    → "รับปุ่มที่กด"
│   │   ├── 🧠 InputHandler       → "ตัดสินใจว่าจะทำอะไร"
│   │   ├── 📡 NetworkController  → "ส่งข้อความไป Server"
│   │   └── 🖼️ LobbyGuiController → "ปุ่ม Play/Cancel"
│   │
│   ├── 📂 Server (ฝั่ง Server) 🖥️
│   │   ├── 🔒 NetworkHandler     → "ตรวจสอบโกง"
│   │   ├── 📍 PlayerStateService → "ผู้เล่นอยู่ไหน?"
│   │   ├── 🏟️ ArenaService       → "ย้ายไป Arena"
│   │   ├── 🏠 LobbyService       → "ย้ายไป Lobby"
│   │   ├── 💀 DeathService       → "ตรวจจับการตาย"
│   │   ├── 🎯 MatchService       → "จัดการแมตช์"
│   │   └── 🎮 GameService        → "ควบคุมเกม"
│   │
│   └── 📂 Shared (ใช้ร่วมกัน) 🤝
│       ├── 📋 Events.luau        → "รายชื่อเหตุการณ์"
│       ├── ⚙️ NetworkConfig      → "ตั้งค่าความปลอดภัย"
│       └── 📡 EventBus           → "ส่งข่าวสาร"
│
└── 📂 docs/ (เอกสาร) 📚
    ├── deps.md                   → "คุณกำลังอ่านอยู่!"
    └── ...
```

---

## 🎬 การทำงานทีละขั้น (เหมือนดูหนัง)

### 🎬 ฉาก 1: ผู้เล่นกดปุ่ม "Play"

```
┌─────────────────────────────────────────────────────────────────┐
│  📱 CLIENT                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👆 ผู้เล่นกดปุ่ม "Play"                                         │
│      │                                                          │
│      ▼                                                          │
│  🖼️ LobbyGuiController                                          │
│      │ "มีคนกดปุ่ม!"                                            │
│      │ ✅ เช็ค: กดบ่อยไปมั้ย? (cooldown 1 วินาที)              │
│      ▼                                                          │
│  🧠 InputHandler                                                 │
│      │ "ส่งคำขอไป Server!"                                      │
│      ▼                                                          │
│  📡 NetworkController                                           │
│      │ "ส่งข้อความ: PLAYER_REQUEST_TO_ARENA"                    │
│      ▼                                                          │
│  ═══════════════════════════════════════════════                │
│             🌐 ส่งผ่าน Internet                                 │
│  ═══════════════════════════════════════════════                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🎬 ฉาก 2: Server ตรวจสอบ

```
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ SERVER                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ═══════════════════════════════════════════════                │
│             🌐 รับข้อความจาก Internet                           │
│  ═══════════════════════════════════════════════                │
│      │                                                          │
│      ▼                                                          │
│  🔒 NetworkHandler (ยาม)                                         │
│      │ "ตรวจสอบ!"                                               │
│      │                                                          │
│      ├─ ❓ ส่งบ่อยไปมั้ย? (Rate Limit)                         │
│      │    └─ ✅ ไม่บ่อย → ผ่าน!                                 │
│      │    └─ ❌ บ่อยเกิน → บล็อก!                               │
│      │                                                          │
│      ├─ ❓ ส่งซ้ำมั้ย? (Anti-Replay)                            │
│      │    └─ ✅ ไม่ซ้ำ → ผ่าน!                                  │
│      │                                                          │
│      └─ ❓ Event นี้อนุญาตมั้ย? (Allowlist)                     │
│           └─ ✅ อนุญาต → ผ่าน!                                  │
│      │                                                          │
│      ▼                                                          │
│  📢 EventBus: "บอกทุกคน! มีคนขอไป Arena!"                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🎬 ฉาก 3: เปลี่ยน State และย้ายตัว

```
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ SERVER (ต่อ)                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📢 EventBus: "PLAYER_REQUEST_TO_ARENA"                          │
│      │                                                          │
│      ├────────────────────┐                                     │
│      ▼                    ▼                                     │
│  📍 PlayerStateService   🏟️ ArenaService                         │
│      │                    │                                     │
│      │ "เปลี่ยน State     │ "รอ State เปลี่ยนก่อน..."           │
│      │  Lobby → Arena"    │                                     │
│      │                    │                                     │
│      │ ✅ ตรวจสอบ:        │                                     │
│      │ • ไม่ล็อกอยู่?     │                                     │
│      │ • cooldown ผ่าน?   │                                     │
│      │                    │                                     │
│      ▼                    │                                     │
│  📢 "State เปลี่ยนแล้ว!" ─►│                                     │
│                           ▼                                     │
│                    🏟️ ArenaService                              │
│                       │                                         │
│                       │ "ย้ายตัวผู้เล่น!"                       │
│                       │ • หา Spawn Point                        │
│                       │ • Teleport ไป Arena                     │
│                       ▼                                         │
│                    ✅ เสร็จ!                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🎬 ฉาก 4: สู้กัน! ตาย!

```
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ SERVER - การตาย                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ⚔️ ผู้เล่น A โจมตี ผู้เล่น B                                    │
│      │                                                          │
│      ▼                                                          │
│  💀 DeathService                                                │
│      │                                                          │
│      │ "ผู้เล่น B ตายแล้ว!"                                     │
│      │                                                          │
│      │ 🔍 วิเคราะห์:                                            │
│      │ • ตายเพราะ: Combat ⚔️                                    │
│      │ • ฆ่าโดย: ผู้เล่น A                                      │
│      │ • อาวุธ: Sword                                           │
│      │                                                          │
│      ▼                                                          │
│  📢 EventBus: "PLAYER_DIED"                                      │
│      │                                                          │
│      ├────────────────────┐                                     │
│      ▼                    ▼                                     │
│  🎯 MatchService        📍 PlayerStateService                    │
│      │                    │                                     │
│      │ "นับแต้ม!"        │ "State = Died"                       │
│      │ • kills++          │ "รอ respawn..."                     │
│      │ • deaths++         │                                     │
│      │ • killStreak++     │                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🧩 Services คืออะไร? (แบบง่ายๆ)

```
┌─────────────────────────────────────────────────────────────────┐
│  🏢 SERVICES = พนักงานแต่ละแผนก                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔒 NetworkHandler                                              │
│     └─ "ยามหน้าประตู - ตรวจคนเข้าออก"                           │
│                                                                 │
│  📍 PlayerStateService                                          │
│     └─ "แผนกบัตรประชาชน - บอกว่าคนนี้อยู่ไหน"                  │
│                                                                 │
│  🏟️ ArenaService                                                │
│     └─ "พนักงานนำทาง Arena - พาคนไป Arena"                      │
│                                                                 │
│  🏠 LobbyService                                                │
│     └─ "พนักงานนำทาง Lobby - พาคนไป Lobby"                     │
│                                                                 │
│  💀 DeathService                                                │
│     └─ "หมอชันสูตร - บอกว่าใครตาย ตายเพราะอะไร"                │
│                                                                 │
│  🎯 MatchService                                                │
│     └─ "กรรมการ - นับแต้ม ดูแลการแข่ง"                          │
│                                                                 │
│  🎮 GameService                                                 │
│     └─ "ผู้จัดการใหญ่ - ดูแลเกมทั้งหมด"                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔒 ความปลอดภัย (7 ชั้น)

```
┌─────────────────────────────────────────────────────────────────┐
│  🛡️ 7 ชั้นป้องกัน (เหมือนปราสาท!)                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ชั้น 1: 🖼️ UI Cooldown                                         │
│          └─ "กดปุ่มได้ทุก 1 วินาที"                              │
│                                                                 │
│  ชั้น 2: 📡 Per-Event Rate Limit                                 │
│          └─ "Event นี้ส่งได้ 1 ครั้ง/5 วินาที"                  │
│                                                                 │
│  ชั้น 3: 🔢 Global Rate Limit                                    │
│          └─ "ส่งได้แค่ 10 อย่าง/5 วินาที"                       │
│                                                                 │
│  ชั้น 4: 🔐 Transition Lock                                      │
│          └─ "กำลังย้าย ห้ามย้ายซ้ำ!"                            │
│                                                                 │
│  ชั้น 5: ⏱️ Transition Cooldown                                  │
│          └─ "ย้ายได้ทุก 2 วินาที"                               │
│                                                                 │
│  ชั้น 6: 🚀 Teleport Cooldown                                    │
│          └─ "Teleport ได้ทุก 5 วินาที"                          │
│                                                                 │
│  ชั้น 7: ⚔️ Combat Check                                         │
│          └─ "กำลังสู้ ห้ามหนี!"                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 ลำดับการเริ่มต้น (Boot Order)

### Server เริ่มก่อน:

```
┌─────────────────────────────────────────────────────────────────┐
│  🖥️ SERVER BOOT (เปิด Server)                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1️⃣  📡 NetworkConfig      → "โหลดตั้งค่า"                       │
│  2️⃣  🔒 NetworkHandler     → "เปิดประตู"                         │
│  3️⃣  🏠 LobbyService       → "เตรียม Lobby"                      │
│  4️⃣  🏟️ ArenaService       → "เตรียม Arena"                      │
│  5️⃣  📍 PlayerStateService → "เตรียมระบบ State"                  │
│  6️⃣  💀 DeathService       → "เตรียมตรวจจับการตาย"               │
│  7️⃣  🎯 MatchService       → "เตรียมระบบแมตช์"                   │
│  8️⃣  🎮 GameService        → "เตรียมเกม"                         │
│                                                                 │
│  ✅ Server พร้อม!                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Client เริ่มทีหลัง:

```
┌─────────────────────────────────────────────────────────────────┐
│  📱 CLIENT BOOT (ผู้เล่นเข้าเกม)                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1️⃣  🎮 InputController     → "เตรียมรับปุ่มกด"                  │
│  2️⃣  🧠 InputHandler        → "เตรียมประมวลผล"                   │
│  3️⃣  📡 NetworkController   → "เชื่อมต่อ Server"                 │
│  4️⃣  🖼️ LobbyGuiController  → "แสดงปุ่ม Play"                    │
│                                                                 │
│  ✅ Client พร้อม!                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 DeathService vs MatchService

```
┌─────────────────────────────────────────────────────────────────┐
│  💀 DeathService                 🎯 MatchService                 │
├────────────────────────────────┬────────────────────────────────┤
│                                │                                │
│  หน้าที่:                       │  หน้าที่:                      │
│  ─────────                     │  ─────────                     │
│  • ตรวจจับการตาย                │  • สร้างแมตช์                   │
│  • บอกว่าตายเพราะอะไร           │  • นับ kills/deaths             │
│  • บอกว่าใครฆ่า                 │  • track kill streaks          │
│                                │  • กำหนด respawn delay          │
│                                │  • สรุปผลแมตช์                  │
│  ทำแค่:                         │                                │
│  ─────                         │  ทำทุกอย่างเกี่ยวกับแมตช์:      │
│  Detect → Classify → Emit      │  ─────────────────────────     │
│  ตรวจจับ → จำแนก → ส่งสัญญาณ   │  Create → Track → End          │
│                                │                                │
│  ❌ ไม่นับแต้ม                  │  ✅ นับแต้ม                     │
│  ❌ ไม่จัดการ respawn           │  ✅ จัดการ respawn delay       │
│  ❌ ไม่รู้เรื่องแมตช์            │  ✅ รู้ทุกอย่างเรื่องแมตช์      │
│                                │                                │
└────────────────────────────────┴────────────────────────────────┘
```

---

## 📡 EventBus คืออะไร?

```
┌─────────────────────────────────────────────────────────────────┐
│  📡 EventBus = วิทยุสื่อสาร                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ไม่มี EventBus:                  มี EventBus:                   │
│  ─────────────────               ─────────────                   │
│                                                                 │
│  A ─────► B                      A ─┐                           │
│  A ─────► C                         ├──► 📡 EventBus           │
│  A ─────► D                         │        │                  │
│  B ─────► C                      B ─┘        ├──► C             │
│  B ─────► D                                  ├──► D             │
│                                              └──► E             │
│  ยุ่งเหยิงมาก!                    เรียบง่าย!                    │
│                                                                 │
│  💡 ทุกคนพูดผ่านวิทยุ ไม่ต้องรู้จักกัน                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📋 Events ที่ใช้

```
┌─────────────────────────────────────────────────────────────────┐
│  📋 รายการ Events (เหตุการณ์)                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🎮 Player Events:                                              │
│  ─────────────────                                              │
│  • PLAYER_REQUEST_TO_ARENA  → "ขอไป Arena"                      │
│  • PLAYER_REQUEST_TO_LOBBY  → "ขอกลับ Lobby"                    │
│  • PLAYER_STATE_CHANGED     → "State เปลี่ยนแล้ว"               │
│  • PLAYER_DIED              → "ตายแล้ว"                         │
│  • PLAYER_DAMAGED           → "โดนตี"                           │
│                                                                 │
│  🎯 Match Events:                                               │
│  ─────────────────                                              │
│  • MATCH_REGISTERED         → "สร้างแมตช์แล้ว"                  │
│  • MATCH_STARTED            → "แมตช์เริ่มแล้ว"                  │
│  • MATCH_ENDED              → "แมตช์จบแล้ว"                     │
│  • MATCH_PLAYER_JOINED      → "มีคนเข้าแมตช์"                   │
│  • MATCH_PLAYER_LEFT        → "มีคนออกจากแมตช์"                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎓 สรุป (1 ประโยค)

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  🎮 OneShortArena =                                              │
│                                                                 │
│  "เกมที่ผู้เล่นกดปุ่ม → Server ตรวจสอบ → ย้ายไป Arena →        │
│   สู้กัน → ตาย → นับแต้ม → วนใหม่!"                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 อ่านเพิ่มเติม

| เอกสาร | เกี่ยวกับ |
|--------|----------|
| [Lobby-to-Arena-Guide](./Lobby-to-Arena-Guide.md) | วิธีย้ายไป Arena |
| [NetworkConfig-Guide](./NetworkConfig-Guide.md) | ตั้งค่าความปลอดภัย |
| [DeathService-Guide](./DeathService-Guide.md) | ระบบตรวจจับการตาย |
| [MatchService-Guide](./MatchService-Guide.md) | ระบบจัดการแมตช์ |
| [Risk-Assessment](./Risk-Assessment.md) | ความปลอดภัย |

---

**Version:** 3.1 - Production Ready  
**อัปเดตล่าสุด:** 2024  
**สถานะ:** ✅ พร้อมใช้งานจริง  
**ทีมพัฒนา:** OneShortArena Team