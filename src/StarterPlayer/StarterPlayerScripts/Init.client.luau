--!strict

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- UTILS & CONFIG
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Utils = ReplicatedStorage:WaitForChild("Utils")
local IdempotentGuard = require(Utils.IdempotentGuard)

-- âœ… FIX #1: Use Guard instead of _G
local bootGuard = IdempotentGuard.new("ClientBootstrap", true)

if not bootGuard:MarkInitialized() then
	warn("[Init.client] âš ï¸ Client already initialized! (via Guard)")
	return
end

print("ğŸ”Œ Client Init: Starting Controllers...")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GET FOLDERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local ControllersRoot = script.Parent
local Core = ControllersRoot:WaitForChild("Core")
local Dev = ControllersRoot:WaitForChild("Dev")
local Gameplay = ControllersRoot:WaitForChild("Gameplay")
local Inputs = ControllersRoot:WaitForChild("Inputs")
local UI = ControllersRoot:WaitForChild("UI")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CONFIGURATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- âœ… FIX #5: Should come from central config (TODO)
-- local ENV = require(ReplicatedStorage.Shared.Environment)
-- local IS_PRODUCTION = ENV.IS_PRODUCTION
local IS_PRODUCTION = false  -- Temporary: hardcoded

-- âœ… FIX #4: Use structured storage for O(n) instead of O(nÂ²)
local controllersByCategory: {[string]: {[string]: any}} = {
	Core = {},
	Inputs = {},
	Gameplay = {},
	UI = {},
	Dev = {},
}

-- âœ… FIX #3: Use qualified keys to prevent name collision
local controllersFlat: {[string]: any} = {} -- For debugging only

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- HELPER FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function loadControllersFromFolder(folder: Folder, categoryName: string, skipInProduction: boolean?)
	print(`[Init.client] Loading {categoryName} controllers...`)
	
	for _, moduleScript in ipairs(folder:GetChildren()) do
		if not moduleScript:IsA("ModuleScript") then
			continue
		end
		
		local controllerName = moduleScript.Name
		
		-- Skip if production and marked to skip
		if IS_PRODUCTION and skipInProduction then
			print(`[Init.client] â­ï¸ Skipped {controllerName} (Production mode)`)
			continue
		end
		
		-- Load controller
		local success, result = pcall(function()
			return require(moduleScript)
		end)
		
		if not success then
			warn(`[Init.client] âŒ Failed to load {controllerName}: {result}`)
			continue
		end
		
		-- âœ… FIX #2: Controller manages its own guard (TODO: move to controller)
		-- For now, we still create it here for backward compatibility
		local guard = IdempotentGuard.new(`{categoryName}.{controllerName}`, false)
		result._guard = guard
		result._category = categoryName
		result._name = controllerName
		
		-- âœ… FIX #4: Store in category-specific table
		controllersByCategory[categoryName][controllerName] = result
		
		-- âœ… FIX #3: Use qualified key for flat storage
		local qualifiedKey = `{categoryName}.{controllerName}`
		controllersFlat[qualifiedKey] = result
		
		print(`[Init.client] âœ… Loaded {categoryName}/{controllerName}`)
	end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD CONTROLLERS (BY CATEGORY)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init.client] ğŸ“¦ Loading controllers by category...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

loadControllersFromFolder(Core, "Core", false)
loadControllersFromFolder(Inputs, "Inputs", false)
loadControllersFromFolder(Gameplay, "Gameplay", false)
loadControllersFromFolder(UI, "UI", false)
loadControllersFromFolder(Dev, "Dev", true)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- INITIALIZE CONTROLLERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init.client] ğŸ”§ Initializing controllers...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

local initOrder = {"Core", "Inputs", "Gameplay", "UI", "Dev"}

-- âœ… FIX #4: O(n) instead of O(nÂ²) - iterate category map directly
for _, category in ipairs(initOrder) do
	for name, controller in pairs(controllersByCategory[category]) do
		if type(controller.Init) ~= "function" then
			continue
		end
		
		local guard = controller._guard
		
		if guard and not guard:MarkInitialized() then
			warn(`[Init.client] âš ï¸ {category}/{name} already initialized, skipping`)
			continue
		end
		
		local initSuccess, initErr = pcall(function()
			controller:Init()
		end)
		
		if not initSuccess then
			warn(`[Init.client] âŒ Failed to init {category}/{name}: {initErr}`)
		else
			print(`[Init.client] âœ… Initialized {category}/{name}`)
		end
	end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- START CONTROLLERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init.client] â–¶ï¸ Starting controllers...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- âœ… FIX #4: O(n) iteration
for _, category in ipairs(initOrder) do
	for name, controller in pairs(controllersByCategory[category]) do
		if type(controller.Start) ~= "function" then
			continue
		end
		
		task.spawn(function()
			local guard = controller._guard
			
			if guard and not guard:MarkStarted() then
				warn(`[Init.client] âš ï¸ {category}/{name} not initialized or already started, skipping`)
				return
			end
			
			local success, err = pcall(function()
				controller:Start()
			end)
			
			if success then
				print(`[Init.client] âœ… Started {category}/{name}`)
			else
				warn(`[Init.client] âŒ Failed to start {category}/{name}: {err}`)
			end
		end)
	end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FINALIZE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- âœ… FIX #1: Mark boot complete via Guard
if not bootGuard:MarkStarted() then
	warn("[Init.client] âš ï¸ Failed to mark boot as started")
end

local bootTime = os.clock()

print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… All controllers initialized and started successfully.")
print(string.format("â±ï¸ Total time: %.3fs", bootTime))
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

-- âœ… Print Guard summary
if IdempotentGuard and IdempotentGuard.printSummary then
	IdempotentGuard.printSummary(bootGuard)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- DEBUG EXPOSURE (Studio only)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if not IS_PRODUCTION or RunService:IsStudio() then
	-- âœ… Expose both flat and structured access
	_G.Controllers = controllersFlat -- Flat with qualified keys
	_G.ControllersByCategory = controllersByCategory -- Structured by category
	_G.BootGuard = bootGuard -- âœ… FIX #1: Expose boot guard
	_G.IdempotentGuard = IdempotentGuard
	
	print("[Init.client] ğŸ” Debug mode enabled:")
	print("  â€¢ _G.Controllers (flat, qualified keys)")
	print("  â€¢ _G.ControllersByCategory (structured)")
	print("  â€¢ _G.BootGuard (boot lifecycle)")
	print("  â€¢ _G.IdempotentGuard (utility)")
end



