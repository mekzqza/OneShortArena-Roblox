--!strict

--[[
    InputHandler - Production Version
    
    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ input actions ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô game commands
    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: Cooldown, State checking, Action queuing
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ‚úÖ Get shared modules
local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)

export type InputHandler = {
	Init: (self: InputHandler) -> (),
	Start: (self: InputHandler) -> (),
	HandlePlay: (self: InputHandler) -> (),
	HandleCancel: (self: InputHandler) -> (),
	HandleAttack: (self: InputHandler) -> (),
}

local InputHandler = {} :: InputHandler

function InputHandler:Init()
	print("[InputHandler] üß† Initialized")
end

function InputHandler:Start()
	EventBus:On(Events.INPUT_ACTION, function(actionName: string)
		if actionName == "PLAY" then
			self:HandlePlay()
		elseif actionName == "CANCEL" then
			self:HandleCancel()
		elseif actionName == "ATTACK" then
			self:HandleAttack()
		else
			warn(`[InputHandler] ‚ö†Ô∏è Unhandled action: {actionName}`)
		end
	end)
	
	print("[InputHandler] ‚úÖ Started")
end

function InputHandler:HandlePlay()
	print("[InputHandler] ‚ñ∂Ô∏è Play button pressed")
	
	-- ‚úÖ ‡πÉ‡∏ä‡πâ Registry
	local Controllers = _G.ControllersByCategory
	
	if not Controllers or not Controllers.Core or not Controllers.Core.NetworkController then
		warn("[InputHandler] ‚ùå NetworkController not available")
		return
	end
	
	local NetworkController = Controllers.Core.NetworkController
	
	NetworkController:Send(Events.PLAYER_REQUEST_TO_ARENA, {
		action = "join",
		timestamp = tick()
	})
end

function InputHandler:HandleCancel()
	print("[InputHandler] ‚è∏Ô∏è Cancel button pressed")
	
	local Controllers = _G.ControllersByCategory
	
	if not Controllers or not Controllers.Core or not Controllers.Core.NetworkController then
		warn("[InputHandler] ‚ùå NetworkController not available")
		return
	end
	
	local NetworkController = Controllers.Core.NetworkController
	
	NetworkController:Send(Events.PLAYER_REQUEST_TO_LOBBY, {
		action = "cancel",
		timestamp = tick()
	})
end

function InputHandler:HandleAttack()
	print("[InputHandler] ‚öîÔ∏è Attack pressed")
	
	local Controllers = _G.ControllersByCategory
	
	if not Controllers or not Controllers.Core or not Controllers.Core.NetworkController then
		warn("[InputHandler] ‚ùå NetworkController not available")
		return
	end
	
	local NetworkController = Controllers.Core.NetworkController
	
	NetworkController:Send(Events.PLAYER_ATTACK, {
		action = "attack",
		timestamp = tick()
	})
end

return InputHandler
