--!strict

--[[
	DemoController - Client-side Network Demo
	
	à¸§à¸´à¸˜à¸µà¸—à¸”à¸ªà¸­à¸š:
	à¸à¸” F9 à¹€à¸›à¸´à¸” Console à¹à¸¥à¹‰à¸§à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡/à¸£à¸±à¸š
	à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰à¸„à¸³à¸ªà¸±à¹ˆà¸‡: _G.DemoController:SendPing()
--]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local Events = require(ReplicatedStorage.Shared.Events)
local NetworkController = require(script.Parent.NetworkController)

export type DemoController = {
	Init: (self: DemoController) -> (),
	Start: (self: DemoController) -> (),
	[string]: any,
}

local DemoController: DemoController = {}

local player = Players.LocalPlayer

local function showChatMessage(text: string, color: Color3)
	pcall(function()
		StarterGui:SetCore("ChatMakeSystemMessage", {
			Text = text,
			Color = color,
		})
	end)
end

function DemoController:Init()
	print("[DemoController] ğŸ® Demo controller initialized")
end

function DemoController:Start()
	-- Example 1: Listen for PONG response
	EventBus:On(Events.DEMO_PONG, function(data: any)
		print("[DemoController] ğŸ“ Received PONG from server:")
		print(`  â€¢ Server Time: {data.serverTime}`)
		print(`  â€¢ Latency: {math.floor(data.latency * 1000)}ms`)
		print(`  â€¢ Message: {data.message}`)
		
		showChatMessage(
			`[PONG] {data.message} (Latency: {math.floor(data.latency * 1000)}ms)`,
			Color3.fromRGB(0, 255, 0)
		)
	end)
	
	-- Example 2: Listen for data response
	EventBus:On(Events.DEMO_SEND_DATA, function(data: any)
		print("[DemoController] ğŸ“Š Received data from server:")
		for key, value in pairs(data) do
			print(`  â€¢ {key}: {value}`)
		end
		
		if data.error then
			warn(`[DemoController] âŒ Error: {data.error}`)
		end
	end)
	
	-- Example 3: Listen for broadcasts (from any player)
	EventBus:On(Events.DEMO_BROADCAST_MESSAGE, function(data: any)
		print(`[DemoController] ğŸ“¢ Broadcast: [{data.playerName}] {data.message}`)
		
		showChatMessage(
			`[{data.playerName}] {data.message}`,
			data.userId == player.UserId 
				and Color3.fromRGB(100, 200, 255) 
				or Color3.fromRGB(200, 200, 200)
		)
	end)
	
	-- Example 4: Listen for counter updates
	EventBus:On(Events.DEMO_UPDATE_COUNTER, function(data: any)
		print(`[DemoController] ğŸ”¢ Counter updated: {data.totalClicks} (Last: {data.lastClicker})`)
		
		showChatMessage(
			`ğŸ”¢ Total: {data.totalClicks} | {data.lastClicker} clicked!`,
			Color3.fromRGB(255, 200, 0)
		)
	end)
	
	print("[DemoController] ğŸš€ Demo controller started")
	print("[DemoController] ğŸ“‹ Available methods:")
	print("  â€¢ :SendPing() - Test ping-pong")
	print("  â€¢ :RequestData(type) - Request server data")
	print("  â€¢ :SendChatMessage(msg) - Send chat message")
	print("  â€¢ :ClickButton(name) - Simulate button click")
	
	-- Auto-send ping every 5 seconds for testing
	task.spawn(function()
		while true do
			task.wait(5)
			self:SendPing()
		end
	end)
end

-- Public methods (callable from console)

function DemoController:SendPing()
	print("[DemoController] ğŸ“¤ Sending PING to server...")
	NetworkController:Send(Events.DEMO_PING, tick())
end

function DemoController:RequestData(dataType: string)
	dataType = dataType or "stats"
	print(`[DemoController] ğŸ“¤ Requesting data: {dataType}`)
	NetworkController:Send(Events.DEMO_REQUEST_DATA, dataType)
end

function DemoController:SendChatMessage(message: string)
	message = message or "Hello from client!"
	print(`[DemoController] ğŸ“¤ Sending chat message: {message}`)
	NetworkController:Send(Events.DEMO_CHAT_MESSAGE, message)
end

function DemoController:ClickButton(buttonName: string)
	buttonName = buttonName or "DemoButton"
	print(`[DemoController] ğŸ“¤ Button clicked: {buttonName}`)
	NetworkController:Send(Events.DEMO_BUTTON_CLICKED, buttonName)
end

-- Example: Send multiple test requests
function DemoController:RunTests()
	print("[DemoController] ğŸ§ª Running all tests...")
	
	task.wait(1)
	self:SendPing()
	
	task.wait(1)
	self:RequestData("stats")
	
	task.wait(1)
	self:RequestData("server")
	
	task.wait(1)
	self:SendChatMessage("Test message from client!")
	
	task.wait(1)
	self:ClickButton("TestButton1")
	
	task.wait(1)
	self:ClickButton("TestButton2")
	
	print("[DemoController] âœ… All tests completed")
end

return DemoController
