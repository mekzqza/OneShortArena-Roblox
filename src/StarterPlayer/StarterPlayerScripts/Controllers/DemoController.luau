--!strict

--[[
	--ğŸ§ª DemoController - Network Testing Demo
	
	--âš ï¸ FOR TESTING ONLY - NOT PRODUCTION
	
	--Purpose:
	-- Demonstrate Client â†’ Server communication
	-- Demonstrate Server â†’ Client communication
	-- Test NetworkController functionality
	
	--Can be deleted when Production is ready.
	
	--Examples:
	-- SendHello() - Simple message to server
	-- SendChatMessage() - Chat with broadcast
	-- RequestPlayerStats() - Request/Response pattern
	-- SendTestButton() - Button click event
]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local NetworkController = require(script.Parent.NetworkController)

export type DemoController = {
	Init: (self: DemoController) -> (),
	Start: (self: DemoController) -> (),
	-- Client â†’ Server methods
	SendHello: (self: DemoController) -> (),
	SendChatMessage: (self: DemoController, message: string) -> (),
	RequestPlayerStats: (self: DemoController) -> (),
	RequestServerInfo: (self: DemoController) -> (),
	SendTestButton: (self: DemoController, buttonNumber: number) -> (),
	SendTestEventToServer: (self: DemoController) -> (),
	-- Legacy methods (for compatibility)
	SendAttack: (self: DemoController) -> (),
	SendDefend: (self: DemoController) -> (),
	SendSpecial: (self: DemoController) -> (),
	SendPing: (self: DemoController) -> (),
	[string]: any,
}

local DemoController = {} :: DemoController

local player = Players.LocalPlayer

function DemoController:Init()
	print("[DemoController] ğŸ§ª Initializing Demo Layer...")
	print("âš ï¸  This is for TESTING only - not Production")
	warn("[DemoController] âœ… Init() CALLED") -- à¹€à¸à¸´à¹ˆà¸¡ debug
end

function DemoController:Start()
	warn("[DemoController] âœ… Start() CALLED") -- à¹€à¸à¸´à¹ˆà¸¡ debug
	
	-- Listen for responses from Server
	self:SetupServerListeners()
	
	-- Legacy: à¸£à¸±à¸š INPUT_ACTION à¸ˆà¸²à¸ InputController
	print("[DemoController] ğŸ“¡ Setting up INPUT_ACTION listener...")
	EventBus:On(Events.INPUT_ACTION, function(actionName: string)
		print("[DemoController] ğŸ¯ Received INPUT_ACTION:", actionName)
		self:OnInputAction(actionName)
	end)
	
	print("[DemoController] ğŸš€ Started - Demo ready")
	print("ğŸ“‹ Available commands:")
	print("  _G.DemoController:SendHello()")
	print("  _G.DemoController:SendChatMessage('text')")
	print("  _G.DemoController:RequestPlayerStats()")
	print("  _G.DemoController:RequestServerInfo()")
end

--[[
	Setup listeners for Server â†’ Client events
]]
function DemoController:SetupServerListeners()
	-- Response to Hello
	
	
	-- Broadcast messages (Chat)
	EventBus:On(Events.DEMO_BROADCAST_MESSAGE, function(data: any)
		print(`[CHAT] {data.playerName}: {data.message}`)
	end)
	
	-- Data responses
	EventBus:On(Events.DEMO_SEND_DATA, function(data: any)
		if data.error then
			warn(`[DemoController] âŒ Error: {data.error}`)
			return
		end
		
		print("[DemoController] ğŸ“Š Received data:")
		for key, value in pairs(data) do
			print(`  {key}: {value}`)
		end
	end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CLIENT â†’ SERVER EXAMPLES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



--[[
	Example 2: Send chat message (will be broadcasted to all)
	
	Usage: _G.DemoController:SendChatMessage("Hello everyone!")
]]
function DemoController:SendChatMessage(message: string)
	if #message == 0 then
		warn("[DemoController] âŒ Message cannot be empty")
		return
	end
	
	if #message > 100 then
		warn("[DemoController] âŒ Message too long (max 100 chars)")
		return
	end
	
	print(`[DemoController] ğŸ’¬ Sending chat: {message}`)
	
	NetworkController:SendToServer(Events.DEMO_CHAT_MESSAGE, {
		message = message,
		timestamp = tick(),
	})
end

--[[
	Example 3: Request player stats from Server
	
	Usage: _G.DemoController:RequestPlayerStats()
]]
function DemoController:RequestPlayerStats()
	print("[DemoController] ğŸ“Š Requesting player stats...")
	
	NetworkController:SendToServer(Events.DEMO_REQUEST_DATA, {
		dataType = "stats",
	})
end

--[[
	Example 4: Request server info
	
	Usage: _G.DemoController:RequestServerInfo()
]]
function DemoController:RequestServerInfo()
	print("[DemoController] ğŸ–¥ï¸ Requesting server info...")
	
	NetworkController:SendToServer(Events.DEMO_REQUEST_DATA, {
		dataType = "server",
	})
end

--[[
	Example 5: Send button click event
	
	Usage: _G.DemoController:SendTestButton(1)
]]


--[[
	Legacy: Manual test event
]]
function DemoController:SendTestEventToServer()
	print("[DemoController] ğŸ“¨ Sending manual test event...")
	
	NetworkController:SendToServer(Events.TEST_CLIENT_BUTTON_CLICK, {
		counter = 1,
		timestamp = tick(),
	})
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LEGACY METHODS (for backward compatibility)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function DemoController:OnInputAction(actionName: string)
	print(`[DemoController] ğŸ® Input: {actionName}`)
	
	local action = string.upper(actionName)
	
	if action == "ATTACK" then
		self:SendAttack()
	elseif action == "DEFEND" then
		self:SendDefend()
	elseif action == "SPECIAL" then
		self:SendSpecial()
	elseif action == "PING" then
		self:SendPing()
	elseif action == "TESTBUTTON1" then
		self:SendTestButton(1)
	elseif action == "TESTBUTTON2" then
		self:SendTestButton(2)
	elseif action == "TESTBUTTON3" then
		self:SendTestButton(3)
	elseif action == "TESTCLICK" then
		self:SendTestEventToServer()
	else
		print(`[DemoController] â„¹ï¸ Action '{actionName}' handled locally`)
	end
end

function DemoController:SendAttack()
	print("[DemoController] âš”ï¸ Sending Attack...")
	
	NetworkController:Send(Events.PLAYER_ATTACK, {
		timestamp = tick(),
		position = player.Character and player.Character.PrimaryPart.Position or Vector3.zero,
	})
end

function DemoController:SendDefend()
	print("[DemoController] ğŸ›¡ï¸ Sending Defend...")
	
	NetworkController:SendToServer(Events.PLAYER_DEFEND, {
		timestamp = tick(),
		isBlocking = true,
	})
end

function DemoController:SendSpecial()
	print("[DemoController] âœ¨ Sending Special...")
	
	NetworkController:SendToServer(Events.PLAYER_SPECIAL, {
		timestamp = tick(),
		skillType = "Ultimate",
	})
end

function DemoController:SendPing()
	print("[DemoController] ğŸ“¡ Sending Ping...")
	
	NetworkController:SendToServer(Events.DEMO_PING, tick())
end

return DemoController