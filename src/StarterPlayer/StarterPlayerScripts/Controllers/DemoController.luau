--!strict

--[ 
	--DemoController - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ InputController + NetworkController
	
	--‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:
	--1. InputController ‡∏à‡∏±‡∏ö input (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° E)
	--2. InputController ‡∏™‡πà‡∏á event ‡∏ú‡πà‡∏≤‡∏ô EventBus
	--3. DemoController ‡∏£‡∏±‡∏ö event ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server
	--4. Server ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
-- ]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local NetworkController = require(script.Parent.NetworkController)

export type DemoController = {
	Init: (self: DemoController) -> (),
	Start: (self: DemoController) -> (),
	SendTestEventToServer: (self: DemoController) -> (),
	[string]: any,
}

local DemoController: DemoController = {}

local player = Players.LocalPlayer 

function DemoController:Init()
	self:Start()
	print("[DemoController] üéÆ Initializing...")
end

function DemoController:Start()
	-- ‡∏£‡∏≠‡∏£‡∏±‡∏ö INPUT_ACTION ‡∏à‡∏≤‡∏Å InputController
	EventBus:On(Events.INPUT_ACTION, function(actionName: string)
		self:OnInputAction(actionName)
	end)
	
end

-- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ input
function DemoController:OnInputAction(actionName: string)
	print(`[DemoController -client] üéÆ Input detected: {actionName}`)
	
	-- ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ case-insensitive
	local action = string.upper(actionName)
	
	if action == "ATTACK" then
		self:SendAttack()
		
	elseif action == "DEFEND" then
		self:SendDefend()
		
	elseif action == "SPECIAL" then
		self:SendSpecial()
		
	elseif action == "PING" then
		self:SendPing()
		
	elseif action == "TESTBUTTON1" then
		self:SendTestButton(1)
		
	elseif action == "TESTBUTTON2" then
		self:SendTestButton(2)
		
	elseif action == "TESTBUTTON3" then
		self:SendTestButton(3)
		
	elseif action == "TESTCLICK" then
		self:SendTestEventToServer()
		
	else
		-- Actions ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á server
		print(`[DemoController] ‚ÑπÔ∏è Action '{actionName}' handled locally`)
	end
end

-- ‡∏™‡πà‡∏á Attack ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server
function DemoController:SendAttack()
	print("[DemoController] ‚öîÔ∏è Sending Attack to server...")
	
	NetworkController:Send(Events.PLAYER_ATTACK, {
		timestamp = tick(),
		position = player.Character and player.Character.PrimaryPart.Position or Vector3.zero,
	})
end

-- ‡∏™‡πà‡∏á Defend ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server
function DemoController:SendDefend()
	print("[DemoController] üõ°Ô∏è Sending Defend to server...")
	
	NetworkController:Send(Events.PLAYER_DEFEND, {
		timestamp = tick(),
		isBlocking = true,
	})
end

-- ‡∏™‡πà‡∏á Special ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server
function DemoController:SendSpecial()
	print("[DemoController] ‚ú® Sending Special to server...")
	
	NetworkController:Send(Events.PLAYER_SPECIAL, {
		timestamp = tick(),
		skillType = "Ultimate",
	})
end

-- ‡∏™‡πà‡∏á Ping (Demo)
function DemoController:SendPing()
	print("[DemoController] üì° Sending Ping to server...")
	
	NetworkController:Send(Events.DEMO_PING, tick())
end

-- ‡∏™‡πà‡∏á Test Button
function DemoController:SendTestButton(buttonNumber: number)
	print(`[DemoController] üîò Sending TestButton{buttonNumber} to server...`)
	
	NetworkController:Send(Events.TEST_BUTTON_PRESSED, {
		buttonId = buttonNumber,
		playerName = player.Name,
		timestamp = tick(),
	})
end

-- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Console ‡πÑ‡∏î‡πâ
function DemoController:SendTestEventToServer()
	local buttonCounter = 1
	NetworkController:Send(Events.TEST_CLIENT_BUTTON_CLICK,"buttonCounter")
	print(`[DemoController-client] üì® Sent TestClientButtonClick with counter {buttonCounter} to server`)
end

return DemoController