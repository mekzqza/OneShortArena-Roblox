--!strict

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)

export type Payload = {
    dataString: string,
dataNumber: number,
dataArray: {
        data: {
            mek1: number,
            mek2: number,
        }
    },
}

export type TestHandler = {
    Init: (self: TestHandler) -> (),
    Start: (self: TestHandler) -> (),
    SendPingWithTrigger_P: (self: TestHandler) -> (),
    SendPingTimer: (self: TestHandler, time: number?) -> (),
    SendPing: (self: TestHandler, data: any?) -> (),
    StopPingTimer: (self: TestHandler) -> (),
    [string]: any,
}

local TestHandler = {} :: TestHandler

-- âœ… à¹€à¸à¹‡à¸š task à¸ªà¸³à¸«à¸£à¸±à¸šà¸¢à¸à¹€à¸¥à¸´à¸
TestHandler.pingTimerTask = nil

function TestHandler:Init()
    print("[TestHandler-Client] ğŸ§ª Initialized")
end

function TestHandler:Start()
    print("[TestHandler-Client] ğŸš€ Starting...")

    -- âœ… Setup input trigger
    self:SendPingWithTrigger_P()
    print("[TestHandler-Client] âœ… Started")
    EventBus:On(Events.TEST_PONG, function(data: any)
        print("[TestHandler-Client] ğŸ“¥ Received pong from server:", data)
    end)

end

-- âœ… à¸ªà¹ˆà¸‡ ping à¹€à¸¡à¸·à¹ˆà¸­à¸à¸” P
function TestHandler:SendPingWithTrigger_P()
    EventBus:On(Events.INPUT_ACTION, function(actionName: string)
        if actionName == "TESTPING" then
            print("[TestHandler-Client] ğŸ® P pressed - Sending ping...")
            
            local payload: Payload = {
                dataString = "888",
                dataNumber = 12345,
                dataArray = {
                    data = {
                        mek1 = 1,
                        mek2 = 2
                    }
                },
            }
            
            self:SendPing(payload)
        end
    end)
end

-- âœ… à¸ªà¹ˆà¸‡ ping à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸ X à¸§à¸´à¸™à¸²à¸—à¸µ
function TestHandler:SendPingTimer(time: number?)
    local interval = time or 5  -- âœ… à¹à¸à¹‰: à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­ wait
    
    -- âœ… à¸«à¸¢à¸¸à¸” timer à¹€à¸à¹ˆà¸²à¸à¹ˆà¸­à¸™ (à¸–à¹‰à¸²à¸¡à¸µ)
    if self.pingTimerTask then
        task.cancel(self.pingTimerTask)
        print("[TestHandler-Client] ğŸ›‘ Stopped previous ping timer")
    end
    
    print(`[TestHandler-Client] ğŸ” Starting auto ping (every {interval}s)`)
    
    -- âœ… à¸ªà¸£à¹‰à¸²à¸‡ task à¹ƒà¸«à¸¡à¹ˆ
    self.pingTimerTask = task.spawn(function()
        while true do
            task.wait(interval)
            
            -- âœ… à¸ªà¸£à¹‰à¸²à¸‡ payload à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡
            local payload: Payload = {
                dataString = "Auto ping",
                dataNumber = math.random(1, 999),
                dataArray = {
                    data = {
                        mek1 = math.random(1, 10),
                        mek2 = math.random(1, 10)
                    }
                },
            }
            
            self:SendPing(payload)
        end
    end)
end

-- âœ… à¸«à¸¢à¸¸à¸” auto ping
function TestHandler:StopPingTimer()
    if self.pingTimerTask then
        task.cancel(self.pingTimerTask)
        self.pingTimerTask = nil
        print("[TestHandler-Client] ğŸ›‘ Ping timer stopped")
    else
        warn("[TestHandler-Client] âš ï¸ No ping timer running")
    end
end

-- âœ… à¸ªà¹ˆà¸‡ ping (à¸£à¸±à¸š any type)
function TestHandler:SendPing(data: any?)
    -- âœ… à¹à¸à¹‰à¹„à¸‚: à¹ƒà¸Šà¹‰ Registry à¸•à¸­à¸™ runtime (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ top level!)
    local Controllers = _G.ControllersByCategory
    
    if not Controllers or not Controllers.Core or not Controllers.Core.NetworkController then
        warn("[TestHandler-Client] âŒ NetworkController not found in Registry!")
        return
    end
    
    local NetworkController = Controllers.Core.NetworkController
    
    local payload = data
    
    -- âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸² à¹ƒà¸Šà¹‰ default
    if not payload then
        payload = {
            dataString = "Default ping",
            dataNumber = 0,
            dataArray = {
                data = {
                    mek1 = 0,
                    mek2 = 0
                }
            },
        }
    end
    
    print("[TestHandler-Client] ğŸ“¤ Sending ping...")
    NetworkController:Send(Events.TEST_PING, payload)
end

return TestHandler