--!strict

--[[
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë ¬† ¬† ¬† ¬† ¬† ¬† ¬†LOBBY GUI CONTROLLER - PRODUCTION GRADE ¬† ¬† ¬† ¬† ¬† ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Purpose: Connect UI buttons to InputController ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë Features: ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Button click ‚Üí EventBus emission ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Visual feedback (hover, click) ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Cooldown visual (disable during cooldown) ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ‚úÖ Get shared modules
local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)

export type LobbyGuiController = {
	Init: (self: LobbyGuiController) -> (),
	Start: (self: LobbyGuiController) -> (),
}

local LobbyGuiController = {} :: LobbyGuiController

-- References
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local lobbyGui: ScreenGui? = nil
local playButton: TextButton? = nil
local cancelButton: TextButton? = nil

-- State
local buttonCooldowns = {} :: {[TextButton]: boolean}

--[[
    Helper Function: connectButton
    ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö EventBus ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ Visual Feedback
]]
local function connectButton(button: TextButton, actionName: string, cooldownTime: number?)
	cooldownTime = cooldownTime or 1.0

	button.MouseButton1Click:Connect(function()
		-- 1. Check Cooldown
		if buttonCooldowns[button] then
			warn(`[LobbyGuiController] ‚è±Ô∏è {actionName} on cooldown (ignored)`)
			return
		end

		print(`[LobbyGuiController] üñºÔ∏è Button clicked: {actionName}`)

		-- 2. Activate Cooldown & Visuals
		buttonCooldowns[button] = true
		local originalText = button.Text
		
		-- Feedback: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
		button.Text = "..." 
		-- (Optional: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)

		-- 3. Emit Event
		EventBus:Emit(Events.INPUT_ACTION, actionName)

		-- 4. Reset after cooldown
		task.delay(cooldownTime, function()
			buttonCooldowns[button] = false
			button.Text = originalText
		end)
	end)
end

function LobbyGuiController:Init()
	print("[LobbyGuiController] üîç Initializing...")

	-- 1. ‡∏£‡∏≠ LobbyGui (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ WaitForChild)
	local gui = playerGui:WaitForChild("LobbyGui", 10)
	if not gui then
		warn("[LobbyGuiController] ‚ùå LobbyGui not found after 10s! Check StarterGui.")
		return
	end

	if not gui:IsA("ScreenGui") then
		warn(`[LobbyGuiController] ‚ùå LobbyGui is not a ScreenGui! (Found: {gui.ClassName})`)
		return
	end

	lobbyGui = gui :: ScreenGui
	print("[LobbyGuiController] ‚úÖ Found LobbyGui")

	-- 2. ‡∏£‡∏≠ PlayButton (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
	local btn = lobbyGui:WaitForChild("PlayButton", 5)
	if not btn or not btn:IsA("TextButton") then
		warn("[LobbyGuiController] ‚ùå PlayButton not found or not a TextButton!")
		return
	end
	playButton = btn :: TextButton
	print("[LobbyGuiController] ‚úÖ Found PlayButton")

	-- 3. ‡∏´‡∏≤ CancelButton (Optional - ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠)
	local cancelBtn = lobbyGui:FindFirstChild("CancelButton")
	if cancelBtn and cancelBtn:IsA("TextButton") then
		cancelButton = cancelBtn :: TextButton
		print("[LobbyGuiController] ‚úÖ Found CancelButton")
	else
		print("[LobbyGuiController] ‚ÑπÔ∏è CancelButton not found (Optional)")
	end

	print("[LobbyGuiController] üé® Initialized successfully!")
end

function LobbyGuiController:Start()
	-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
	if not playButton then
		warn("[LobbyGuiController] ‚ö†Ô∏è Cannot start: PlayButton not initialized")
		return
	end

	print("[LobbyGuiController] üöÄ Starting logic...")

	-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° Play
	connectButton(playButton, "PLAY", 1.0)
	print("[LobbyGuiController] ‚úÖ Connected PLAY action")

	-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° Cancel (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
	if cancelButton then
		connectButton(cancelButton, "CANCEL", 0.5)
		print("[LobbyGuiController] ‚úÖ Connected CANCEL action")
	end
end

return LobbyGuiController