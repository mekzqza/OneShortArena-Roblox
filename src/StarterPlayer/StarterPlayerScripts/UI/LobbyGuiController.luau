--!strict

--[[
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë ¬† ¬† ¬† ¬† ¬† ¬† ¬†LOBBY GUI CONTROLLER - PRODUCTION GRADE ¬† ¬† ¬† ¬† ¬† ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Purpose: Connect UI buttons to InputController ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë Features: ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Button click ‚Üí EventBus emission ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Visual feedback (hover, click) ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†‚ïë
‚ïë ¬†‚úÖ Cooldown visual (disable during cooldown) ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ‚úÖ Get shared modules
local Events = require(ReplicatedStorage.Shared.Events)
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)

export type LobbyGuiController = {
	Init: (self: LobbyGuiController) -> (),
	Start: (self: LobbyGuiController) -> (),
}

local LobbyGuiController = {} :: LobbyGuiController

-- References
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local lobbyGui: ScreenGui? = nil
local playButton: TextButton? = nil
local cancelButton: TextButton? = nil

local buttonCooldowns = {} :: {[TextButton]: boolean}

-- ‚úÖ NEW: Track if player is Downed
local isPlayerDowned = false

-- ‚úÖ NEW: Dependencies storage
local Dependencies: {
	NetworkController: any?,
	PlayerStateController: any?,
} = {}

local function connectButton(button: TextButton, actionName: string, cooldownTime: number?)
	cooldownTime = cooldownTime or 1.0
	
	button.MouseButton1Click:Connect(function()
		-- ‚úÖ NEW: Check if Downed
		if isPlayerDowned and actionName ~= "CANCEL" then
			warn(`[LobbyGuiController] üö´ {actionName} blocked: Player is Downed`)
			
			-- Visual feedback
			local originalColor = button.BackgroundColor3
			button.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
			task.delay(0.3, function()
				button.BackgroundColor3 = originalColor
			end)
			
			return
		end
		
		if buttonCooldowns[button] then
			warn(`[LobbyGuiController] ‚è±Ô∏è {actionName} on cooldown (ignored)`)
			return
		end
		
		print(`[LobbyGuiController] üñºÔ∏è Button clicked: {actionName}`)
		
		buttonCooldowns[button] = true
		
		EventBus:Emit(Events.INPUT_ACTION, actionName)
		
		local originalColor = button.BackgroundColor3
		local originalText = button.Text
		button.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
		button.Text = "..."
		
		task.delay(cooldownTime, function()
			buttonCooldowns[button] = false
			button.BackgroundColor3 = originalColor
			button.Text = originalText
		end)
	end)
end

-- ‚úÖ NEW: SetDependencies (called by Init.client before Init)
function LobbyGuiController:SetDependencies(locator: any)
	-- Safe dependency resolution
	Dependencies.NetworkController = locator:Get("NetworkController")
	Dependencies.PlayerStateController = locator:Get("PlayerStateController")
	
	-- Validate critical dependencies
	if not Dependencies.NetworkController then
		warn("[LobbyGuiController] ‚ö†Ô∏è NetworkController not found!")
	end
end

function LobbyGuiController:Init()
	print("[LobbyGuiController] üîç Initializing...")

	-- 1. ‡∏£‡∏≠ LobbyGui (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ WaitForChild)
	local gui = playerGui:WaitForChild("LobbyGui", 10)
	if not gui then
		warn("[LobbyGuiController] ‚ùå LobbyGui not found after 10s! Check StarterGui.")
		return
	end

	if not gui:IsA("ScreenGui") then
		warn(`[LobbyGuiController] ‚ùå LobbyGui is not a ScreenGui! (Found: {gui.ClassName})`)
		return
	end

	lobbyGui = gui :: ScreenGui
	print("[LobbyGuiController] ‚úÖ Found LobbyGui")

	-- 2. ‡∏£‡∏≠ PlayButton (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
	local btn = lobbyGui:WaitForChild("PlayButton", 5)
	if not btn or not btn:IsA("TextButton") then
		warn("[LobbyGuiController] ‚ùå PlayButton not found or not a TextButton!")
		return
	end
	playButton = btn :: TextButton
	print("[LobbyGuiController] ‚úÖ Found PlayButton")

	-- 3. ‡∏´‡∏≤ CancelButton (Optional - ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠)
	local cancelBtn = lobbyGui:FindFirstChild("CancelButton")
	if cancelBtn and cancelBtn:IsA("TextButton") then
		cancelButton = cancelBtn :: TextButton
		print("[LobbyGuiController] ‚úÖ Found CancelButton")
	else
		print("[LobbyGuiController] ‚ÑπÔ∏è CancelButton not found (Optional)")
	end

	-- Now you can use dependencies safely
	if Dependencies.NetworkController then
		print("[LobbyGuiController] ‚úÖ NetworkController available")
	end

	print("[LobbyGuiController] üé® Initialized successfully!")
end

function LobbyGuiController:Start()
	-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
	if not playButton then
		warn("[LobbyGuiController] ‚ö†Ô∏è Cannot start: PlayButton not initialized")
		return
	end

	print("[LobbyGuiController] üöÄ Starting logic...")

	-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° Play
	connectButton(playButton, "PLAY", 1.0)
	print("[LobbyGuiController] ‚úÖ Connected PLAY action")

	-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° Cancel (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
	if cancelButton then
		connectButton(cancelButton, "CANCEL", 0.5)
		print("[LobbyGuiController] ‚úÖ Connected CANCEL action")
	end
	
	-- ‚úÖ NEW: Listen for Downed state
	EventBus:On(Events.PLAYER_DOWNED, function(data: any)
		print("[LobbyGuiController] ü¶µ Player is DOWNED - disabling Play button")
		isPlayerDowned = true
		
		if playButton then
			playButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
			playButton.Text = "‚ùå Downed"
		end
	end)
	
	EventBus:On(Events.PLAYER_REVIVED, function(data: any)
		print("[LobbyGuiController] üíö Player REVIVED - enabling Play button")
		isPlayerDowned = false
		
		if playButton then
			playButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
			playButton.Text = "‚ñ∂ Play"
		end
	end)
	
	EventBus:On(Events.PLAYER_DIED, function(data: any)
		print("[LobbyGuiController] üíÄ Player DIED - disabling Play button")
		isPlayerDowned = false
		
		if playButton then
			playButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
			playButton.Text = "‚ò†Ô∏è Died"
		end
	end)
	
	-- Use dependencies in Start
	if Dependencies.PlayerStateController then
		-- Do something
	end
end

return LobbyGuiController