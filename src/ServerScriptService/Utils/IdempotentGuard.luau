--!strict

--[[
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            IDEMPOTENT GUARD UTILITY - PRODUCTION GRADE         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Purpose: Prevent double initialization/execution              â•‘
â•‘ Features:                                                      â•‘
â•‘  âœ… Reusable across all Services/Controllers                  â•‘
â•‘  âœ… Thread-safe state tracking                                â•‘
â•‘  âœ… Lifecycle validation (Init â†’ Start order)                 â•‘
â•‘  âœ… Debug mode support                                        â•‘
â•‘  âœ… Analytics tracking                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TYPE DEFINITIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type LifecycleState = "Created" | "Initialized" | "Started" | "Stopped"

export type GuardInstance = {
	-- State queries
	IsInitialized: (self: GuardInstance) -> boolean,
	IsStarted: (self: GuardInstance) -> boolean,
	IsStopped: (self: GuardInstance) -> boolean,
	GetState: (self: GuardInstance) -> LifecycleState,
	
	-- State transitions
	MarkInitialized: (self: GuardInstance) -> boolean,
	MarkStarted: (self: GuardInstance) -> boolean,
	MarkStopped: (self: GuardInstance) -> boolean,
	
	-- Validation
	RequireInitialized: (self: GuardInstance) -> (),
	RequireNotInitialized: (self: GuardInstance) -> (),
	RequireStarted: (self: GuardInstance) -> (),
	
	-- Utilities
	Reset: (self: GuardInstance) -> (),
	GetAnalytics: (self: GuardInstance) -> {[string]: any},
	
	-- Internal
	_name: string,
	_state: LifecycleState,
	_initTime: number?,
	_startTime: number?,
	_stopTime: number?,
	_initCount: number,
	_startCount: number,
	_debug: boolean,
}

local IdempotentGuard = {}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GLOBAL REGISTRY
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local guards: {[string]: GuardInstance} = {}
local globalStats = {
	totalGuardsCreated = 0,
	totalInitAttempts = 0,
	totalStartAttempts = 0,
	blockedInits = 0,
	blockedStarts = 0,
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PRIVATE FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function log(guard: GuardInstance, level: "Info" | "Warn" | "Error", message: string)
	if not guard._debug and level == "Info" then
		return
	end
	
	local prefix = string.format("[IdempotentGuard:%s]", guard._name)
	
	if level == "Error" then
		error(prefix .. " " .. message)
	elseif level == "Warn" then
		warn(prefix .. " " .. message)
	else
		print(prefix .. " " .. message)
	end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CONSTRUCTOR
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

--[[
	Create a new IdempotentGuard instance
	
	@param name string - Identifier for this guard (e.g., "NetworkHandler")
	@param debug boolean? - Enable debug logging
	@return GuardInstance
	
	Example:
		local guard = IdempotentGuard.new("MyService", true)
]]
function IdempotentGuard.new(name: string, debug: boolean?): GuardInstance
	-- Check if guard already exists
	if guards[name] then
		warn(`[IdempotentGuard] âš ï¸ Guard '{name}' already exists! Returning existing instance.`)
		return guards[name]
	end
	
	local self = {} :: GuardInstance
	
	-- Properties
	self._name = name
	self._state = "Created"
	self._debug = debug or false
	self._initTime = nil
	self._startTime = nil
	self._stopTime = nil
	self._initCount = 0
	self._startCount = 0
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- STATE QUERIES
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	function self:IsInitialized(): boolean
		return self._state == "Initialized" or self._state == "Started" or self._state == "Stopped"
	end
	
	function self:IsStarted(): boolean
		return self._state == "Started"
	end
	
	function self:IsStopped(): boolean
		return self._state == "Stopped"
	end
	
	function self:GetState(): LifecycleState
		return self._state
	end
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- STATE TRANSITIONS
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	function self:MarkInitialized(): boolean
		self._initCount += 1
		globalStats.totalInitAttempts += 1
		
		if self:IsInitialized() then
			log(self, "Warn", `âš ï¸ Already initialized! (State: {self._state})`)
			globalStats.blockedInits += 1
			return false
		end
		
		self._state = "Initialized"
		self._initTime = os.clock()
		
		log(self, "Info", "âœ… Marked as Initialized")
		return true
	end
	
	function self:MarkStarted(): boolean
		self._startCount += 1
		globalStats.totalStartAttempts += 1
		
		if self:IsStarted() then
			log(self, "Warn", `âš ï¸ Already started! (State: {self._state})`)
			globalStats.blockedStarts += 1
			return false
		end
		
		if not self:IsInitialized() then
			log(self, "Error", "âŒ Cannot start before Init()!")
			return false
		end
		
		self._state = "Started"
		self._startTime = os.clock()
		
		log(self, "Info", "âœ… Marked as Started")
		return true
	end
	
	function self:MarkStopped(): boolean
		if self:IsStopped() then
			log(self, "Warn", "âš ï¸ Already stopped!")
			return false
		end
		
		self._state = "Stopped"
		self._stopTime = os.clock()
		
		log(self, "Info", "ğŸ›‘ Marked as Stopped")
		return true
	end
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- VALIDATION
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	function self:RequireInitialized()
		if not self:IsInitialized() then
			error(`[{self._name}] âŒ Must be initialized first! (Current state: {self._state})`)
		end
	end
	
	function self:RequireNotInitialized()
		if self:IsInitialized() then
			error(`[{self._name}] âŒ Already initialized! (State: {self._state})`)
		end
	end
	
	function self:RequireStarted()
		if not self:IsStarted() then
			error(`[{self._name}] âŒ Must be started first! (Current state: {self._state})`)
		end
	end
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- UTILITIES
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	function self:Reset()
		log(self, "Warn", "âš ï¸ Resetting guard state...")
		self._state = "Created"
		self._initTime = nil
		self._startTime = nil
		self._stopTime = nil
	end
	
	function self:GetAnalytics(): {[string]: any}
		local now = os.clock()
		
		return {
			name = self._name,
			state = self._state,
			initCount = self._initCount,
			startCount = self._startCount,
			initTime = self._initTime,
			startTime = self._startTime,
			stopTime = self._stopTime,
			uptime = self._startTime and (self._stopTime or now) - self._startTime or 0,
			timeSinceInit = self._initTime and now - self._initTime or 0,
		}
	end
	
	-- Register in global registry
	guards[name] = self
	globalStats.totalGuardsCreated += 1
	
	log(self, "Info", `ğŸ›¡ï¸ Created (Debug: {self._debug})`)
	
	return self
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GLOBAL UTILITIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

--[[
	Get existing guard by name
	
	@param name string
	@return GuardInstance?
]]
function IdempotentGuard.get(name: string): GuardInstance?
	return guards[name]
end

--[[
	Get all registered guards
	
	@return {[string]: GuardInstance}
]]
function IdempotentGuard.getAll(): {[string]: GuardInstance}
	return guards
end

--[[
	Get global statistics
	
	@return {[string]: any}
]]
function IdempotentGuard.getGlobalStats(): {[string]: any}
	local stats = {
		totalGuardsCreated = globalStats.totalGuardsCreated,
		totalInitAttempts = globalStats.totalInitAttempts,
		totalStartAttempts = globalStats.totalStartAttempts,
		blockedInits = globalStats.blockedInits,
		blockedStarts = globalStats.blockedStarts,
		activeGuards = 0,
		states = {
			Created = 0,
			Initialized = 0,
			Started = 0,
			Stopped = 0,
		},
	}
	
	for _, guard in pairs(guards) do
		stats.activeGuards += 1
		stats.states[guard._state] = (stats.states[guard._state] or 0) + 1
	end
	
	return stats
end

--[[
	Print summary of all guards (debug)
]]
function IdempotentGuard.printSummary()
	print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
	print("â•‘              IDEMPOTENT GUARD SUMMARY                          â•‘")
	print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
	
	local stats = IdempotentGuard.getGlobalStats()
	print(string.format("â•‘ Total Guards: %d", stats.totalGuardsCreated))
	print(string.format("â•‘ Init Attempts: %d (Blocked: %d)", stats.totalInitAttempts, stats.blockedInits))
	print(string.format("â•‘ Start Attempts: %d (Blocked: %d)", stats.totalStartAttempts, stats.blockedStarts))
	print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
	
	for name, guard in pairs(guards) do
		local symbol = guard._state == "Started" and "âœ…" 
			or guard._state == "Initialized" and "ğŸ”µ"
			or guard._state == "Stopped" and "ğŸ›‘"
			or "âšª"
		
		print(string.format("â•‘ %s %-30s %s", symbol, name, guard._state))
	end
	
	print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
end

-- à¹€à¸à¸´à¹ˆà¸¡ cleanup method
function IdempotentGuard.remove(name: string)
    if guards[name] then
        guards[name] = nil
        globalStats.totalGuardsCreated -= 1
    end
end

return IdempotentGuard

--[[]
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               ğŸ“š IDEMPOTENT GUARD - à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘ ğŸ¯ PURPOSE (à¸ˆà¸¸à¸”à¸›à¸£à¸°à¸ªà¸‡à¸„à¹Œ):                                       â•‘
â•‘    à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£ Init() à¹à¸¥à¸° Start() à¸‹à¹‰à¸³à¸‹à¹‰à¸­à¸™à¹ƒà¸™ Service/Controller â•‘
â•‘    à¸£à¸±à¸à¸©à¸² lifecycle à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (Created â†’ Init â†’ Start)        â•‘
â•‘                                                                â•‘
â•‘ âœ¨ FEATURES (à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œà¸«à¸¥à¸±à¸):                                      â•‘
â•‘    1. State Tracking    - à¸•à¸´à¸”à¸•à¸²à¸¡ lifecycle state              â•‘
â•‘    2. Double-Init Guard - à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ Init à¸‹à¹‰à¸³                    â•‘
â•‘    3. Order Validation  - à¸•à¹‰à¸­à¸‡ Init à¸à¹ˆà¸­à¸™ Start à¹€à¸ªà¸¡à¸­           â•‘
â•‘    4. Analytics         - à¹€à¸à¹‡à¸šà¸ªà¸–à¸´à¸•à¸´à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™                  â•‘
â•‘    5. Global Registry   - à¸”à¸¹ guard à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹„à¸”à¹‰                 â•‘
â•‘                                                                â•‘
â•‘ ğŸ“– BASIC USAGE (à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¸à¸·à¹‰à¸™à¸à¸²à¸™):                               â•‘
â•‘                                                                â•‘
â•‘    local IdempotentGuard = require(...)                       â•‘
â•‘    local guard = IdempotentGuard.new("MyService", true)       â•‘
â•‘                                                                â•‘
â•‘    function MyService:Init()                                  â•‘
â•‘        if not guard:MarkInitialized() then                    â•‘
â•‘            return  -- Already initialized                     â•‘
â•‘        end                                                     â•‘
â•‘        -- Init logic here (à¸£à¸±à¸™à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§)                    â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    function MyService:Start()                                 â•‘
â•‘        if not guard:MarkStarted() then                        â•‘
â•‘            return  -- Already started or not initialized      â•‘
â•‘        end                                                     â•‘
â•‘        -- Start logic here (à¸£à¸±à¸™à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§)                   â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘ ğŸ”„ LIFECYCLE STATES (à¸ªà¸–à¸²à¸™à¸°à¸•à¹ˆà¸²à¸‡à¹†):                             â•‘
â•‘                                                                â•‘
â•‘    1. Created      â†’ guard à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰ init          â•‘
â•‘    2. Initialized  â†’ Init() à¹€à¸£à¸µà¸¢à¸à¹à¸¥à¹‰à¸§ à¸à¸£à¹‰à¸­à¸¡ Start             â•‘
â•‘    3. Started      â†’ Start() à¹€à¸£à¸µà¸¢à¸à¹à¸¥à¹‰à¸§ à¸à¸³à¸¥à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™            â•‘
â•‘    4. Stopped      â†’ Stop() à¹€à¸£à¸µà¸¢à¸à¹à¸¥à¹‰à¸§ à¸«à¸¢à¸¸à¸”à¸—à¸³à¸‡à¸²à¸™              â•‘
â•‘                                                                â•‘
â•‘    Transition Flow:                                           â•‘
â•‘    Created â†’ Initialized â†’ Started â†’ Stopped                  â•‘
â•‘                                                                â•‘
â•‘ ğŸ“ ADVANCED USAGE (à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸‚à¸±à¹‰à¸™à¸ªà¸¹à¸‡):                             â•‘
â•‘                                                                â•‘
â•‘    -- Require state à¸à¹ˆà¸­à¸™à¸—à¸³à¸‡à¸²à¸™                                 â•‘
â•‘    function MyService:DoSomething()                           â•‘
â•‘        guard:RequireStarted()  -- Error à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆ Start       â•‘
â•‘        -- Safe to execute                                     â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    -- à¹€à¸Šà¹‡à¸„à¸ªà¸–à¸²à¸™à¸°                                                â•‘
â•‘    if guard:IsInitialized() then                              â•‘
â•‘        print("Ready to start!")                               â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    -- à¸”à¸¹ analytics                                             â•‘
â•‘    local analytics = guard:GetAnalytics()                     â•‘
â•‘    print("Uptime:", analytics.uptime)                         â•‘
â•‘    print("Init count:", analytics.initCount)                  â•‘
â•‘                                                                â•‘
â•‘ ğŸ’¡ USE CASES (à¸à¸£à¸“à¸µà¹ƒà¸Šà¹‰à¸‡à¸²à¸™):                                     â•‘
â•‘                                                                â•‘
â•‘    âœ… à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ Service/Controller Init à¸‹à¹‰à¸³                     â•‘
â•‘    âœ… à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰ Init à¸à¹ˆà¸­à¸™ Start                               â•‘
â•‘    âœ… à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ memory leak à¸ˆà¸²à¸ double initialization          â•‘
â•‘    âœ… à¸•à¸´à¸”à¸•à¸²à¸¡ lifecycle à¸‚à¸­à¸‡ modules                            â•‘
â•‘    âœ… Debug à¹„à¸”à¹‰à¸‡à¹ˆà¸²à¸¢à¸§à¹ˆà¸² module à¹„à¸«à¸™ Init/Start à¹à¸¥à¹‰à¸§            â•‘
â•‘                                                                â•‘
â•‘ âš ï¸ IMPORTANT NOTES (à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡):                             â•‘
â•‘                                                                â•‘
â•‘    â€¢ à¸ªà¸£à¹‰à¸²à¸‡ guard à¹€à¸à¸µà¸¢à¸‡à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§à¸•à¹ˆà¸­ module                    â•‘
â•‘    â€¢ à¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆ unique à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° service                     â•‘
â•‘    â€¢ à¹€à¸Šà¹‡à¸„ return value à¸‚à¸­à¸‡ Mark* methods                     â•‘
â•‘    â€¢ à¸­à¸¢à¹ˆà¸² Reset() à¹ƒà¸™ production (à¹ƒà¸Šà¹‰à¹€à¸‰à¸à¸²à¸° testing)           â•‘
â•‘                                                                â•‘
â•‘ ğŸ“Š GLOBAL UTILITIES (à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¹ˆà¸§à¸™à¸à¸¥à¸²à¸‡):                       â•‘
â•‘                                                                â•‘
â•‘    -- à¸”à¸¹ guard à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”                                         â•‘
â•‘    local allGuards = IdempotentGuard.getAll()                 â•‘
â•‘    for name, guard in allGuards do                            â•‘
â•‘        print(name, guard:GetState())                          â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    -- à¸”à¸¹ guard à¹€à¸‰à¸à¸²à¸°                                           â•‘
â•‘    local guard = IdempotentGuard.get("NetworkHandler")        â•‘
â•‘    if guard then                                              â•‘
â•‘        print(guard:GetState())                                â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    -- à¸”à¸¹à¸ªà¸–à¸´à¸•à¸´à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”                                           â•‘
â•‘    local stats = IdempotentGuard.getGlobalStats()             â•‘
â•‘    print("Total guards:", stats.totalGuardsCreated)           â•‘
â•‘    print("Blocked inits:", stats.blockedInits)                â•‘
â•‘                                                                â•‘
â•‘    -- à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¹à¸šà¸šà¸ªà¸§à¸¢                                           â•‘
â•‘    IdempotentGuard.printSummary()                             â•‘
â•‘                                                                â•‘
â•‘ ğŸ¯ REAL-WORLD EXAMPLE (à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸ˆà¸£à¸´à¸‡):                         â•‘
â•‘                                                                â•‘
â•‘    -- NetworkHandler.luau                                     â•‘
â•‘    local guard = IdempotentGuard.new("NetworkHandler", true)  â•‘
â•‘                                                                â•‘
â•‘    function NetworkHandler:Init()                             â•‘
â•‘        if not guard:MarkInitialized() then                    â•‘
â•‘            return                                             â•‘
â•‘        end                                                     â•‘
â•‘        -- à¸ªà¸£à¹‰à¸²à¸‡ RemoteEvent (à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§)                     â•‘
â•‘        self.remoteEvent = Instance.new("RemoteEvent")         â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    function NetworkHandler:Start()                            â•‘
â•‘        if not guard:MarkStarted() then                        â•‘
â•‘            return                                             â•‘
â•‘        end                                                     â•‘
â•‘        -- Connect events (à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§)                         â•‘
â•‘        self.remoteEvent.OnServerEvent:Connect(...)            â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘    function NetworkHandler:SendData(data)                     â•‘
â•‘        guard:RequireStarted()  -- à¸•à¹‰à¸­à¸‡ Start à¹à¸¥à¹‰à¸§            â•‘
â•‘        self.remoteEvent:FireAllClients(data)                  â•‘
â•‘    end                                                         â•‘
â•‘                                                                â•‘
â•‘ ğŸ› DEBUGGING (à¸à¸²à¸£ Debug):                                     â•‘
â•‘                                                                â•‘
â•‘    -- F9 Console                                              â•‘
â•‘    _G.IdempotentGuard.printSummary()                          â•‘
â•‘                                                                â•‘
â•‘    -- à¹€à¸Šà¹‡à¸„ state à¸‚à¸­à¸‡ service                                  â•‘
â•‘    local guard = _G.IdempotentGuard.get("NetworkHandler")     â•‘
â•‘    print(guard:GetState())  -- "Started"                      â•‘
â•‘                                                                â•‘
â•‘    -- à¸”à¸¹ analytics                                             â•‘
â•‘    local stats = _G.IdempotentGuard.getGlobalStats()          â•‘
â•‘    print(stats)                                               â•‘
â•‘                                                                â•‘
â•‘ ğŸ“š API REFERENCE (à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” API):                            â•‘
â•‘                                                                â•‘
â•‘    Constructor:                                               â•‘
â•‘    â€¢ new(name, debug) -> GuardInstance                        â•‘
â•‘                                                                â•‘
â•‘    State Queries:                                             â•‘
â•‘    â€¢ IsInitialized() -> boolean                               â•‘
â•‘    â€¢ IsStarted() -> boolean                                   â•‘
â•‘    â€¢ IsStopped() -> boolean                                   â•‘
â•‘    â€¢ GetState() -> LifecycleState                             â•‘
â•‘                                                                â•‘
â•‘    State Transitions:                                         â•‘
â•‘    â€¢ MarkInitialized() -> boolean                             â•‘
â•‘    â€¢ MarkStarted() -> boolean                                 â•‘
â•‘    â€¢ MarkStopped() -> boolean                                 â•‘
â•‘                                                                â•‘
â•‘    Validation:                                                â•‘
â•‘    â€¢ RequireInitialized()                                     â•‘
â•‘    â€¢ RequireNotInitialized()                                  â•‘
â•‘    â€¢ RequireStarted()                                         â•‘
â•‘                                                                â•‘
â•‘    Utilities:                                                 â•‘
â•‘    â€¢ Reset()                                                  â•‘
â•‘    â€¢ GetAnalytics() -> table                                  â•‘
â•‘                                                                â•‘
â•‘    Global Functions:                                          â•‘
â•‘    â€¢ IdempotentGuard.get(name) -> GuardInstance?              â•‘
â•‘    â€¢ IdempotentGuard.getAll() -> {[string]: GuardInstance}    â•‘
â•‘    â€¢ IdempotentGuard.getGlobalStats() -> table                â•‘
â•‘    â€¢ IdempotentGuard.printSummary()                           â•‘
â•‘                                                                â•‘
â•‘ ğŸ“ BEST PRACTICES (à¹à¸™à¸§à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸”à¸µ):                              â•‘
â•‘                                                                â•‘
â•‘    âœ… à¸ªà¸£à¹‰à¸²à¸‡ guard à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§à¸•à¹ˆà¸­ module (module-level)         â•‘
â•‘    âœ… à¹€à¸Šà¹‡à¸„ return value à¸‚à¸­à¸‡ Mark* à¹€à¸ªà¸¡à¸­                       â•‘
â•‘    âœ… à¹ƒà¸Šà¹‰ Require* à¸ªà¸³à¸«à¸£à¸±à¸š critical operations                 â•‘
â•‘    âœ… à¹€à¸›à¸´à¸” debug mode à¹ƒà¸™ development                          â•‘
â•‘    âœ… à¹ƒà¸Šà¹‰ printSummary() à¹€à¸à¸·à¹ˆà¸­ monitor services               â•‘
â•‘                                                                â•‘
â•‘    âŒ à¸­à¸¢à¹ˆà¸²à¸ªà¸£à¹‰à¸²à¸‡ guard à¹ƒà¸™ function (memory leak!)             â•‘
â•‘    âŒ à¸­à¸¢à¹ˆà¸²à¸¥à¸·à¸¡à¹€à¸Šà¹‡à¸„ return value                                â•‘
â•‘    âŒ à¸­à¸¢à¹ˆà¸² Reset() à¹ƒà¸™ production                              â•‘
â•‘    âŒ à¸­à¸¢à¹ˆà¸²à¹ƒà¸Šà¹‰à¸Šà¸·à¹ˆà¸­à¸‹à¹‰à¸³à¸à¸±à¸™                                        â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TLDR (à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™à¹†):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IdempotentGuard = à¸•à¸±à¸§à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£ Init/Start à¸‹à¹‰à¸³à¸‹à¹‰à¸­à¸™

à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ 3 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™:
1. à¸ªà¸£à¹‰à¸²à¸‡:    local guard = IdempotentGuard.new("ServiceName")
2. à¹ƒà¸™ Init:  if not guard:MarkInitialized() then return end
3. à¹ƒà¸™ Start: if not guard:MarkStarted() then return end

Lifecycle: Created â†’ Initialized â†’ Started â†’ Stopped

à¹€à¸«à¸¡à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸š:
â€¢ à¸—à¸¸à¸ Service à¹à¸¥à¸° Controller
â€¢ à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ double initialization
â€¢ à¸šà¸±à¸‡à¸„à¸±à¸š Init â†’ Start order
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Version: 1.0.0
Author: OneShortArena Team
Last Updated: 2024
]]
