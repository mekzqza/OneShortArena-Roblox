--!strict

local ServerScriptService = game:GetService("ServerScriptService")
-- local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD PROMISE LIBRARY
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Packages = ReplicatedStorage:WaitForChild("Packages")
local Promise = require(Packages.Promise)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- IDEMPOTENT GUARD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if _G.__SERVER_INITIALIZED then
	warn("[Init.server] âš ï¸ Server already initialized! Skipping re-initialization.")
	return
end

local bootStartTime = os.clock()

print("ğŸ”Œ Server Init: Starting Services...")
print(`â±ï¸  Boot started at: {os.date("%X", os.time())}`)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âœ… TIMEOUTS - à¸•à¹‰à¸­à¸‡à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸™à¸µà¹ˆ! à¸à¹ˆà¸­à¸™ HELPER FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local TIMEOUTS = {
	ServiceInit = 15,     -- Max 15s per service Init
	ServiceStart = 15,    -- Max 15s per service Start
	LayerInit = 45,       -- Max 45s per layer Init
	LayerStart = 45,      -- Max 45s per layer Start
}

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GET FOLDERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Services = ServerScriptService:WaitForChild("Services")
local Utils = ServerScriptService:WaitForChild("Utils")

-- âœ… NEW: Services subfolders
local Core = Services:WaitForChild("Core")
local Gameplay = Services:WaitForChild("Gameplay")
local Player = Services:WaitForChild("Player")
local Data = Services:WaitForChild("Data")
local Cloud = Services:WaitForChild("Cloud")

-- -- âœ… Preload NetworkConfig
-- local Configs = ServerStorage:WaitForChild("Configs")
-- local NetworkConfig = require(Configs.NetworkConfig)



-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD SERVICES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Core Services
print("[Init] Loading Core services...")
local NetworkHandler = require(Core.NetworkHandler)
local CmdrService = require(Core.CmdrService)  -- âœ… à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰

-- Gameplay Services
print("[Init] Loading Gameplay services...")
local ArenaService = require(Gameplay.ArenaService)
local CombatService = require(Gameplay.CombatService)    -- âœ… NEW
local CooldownService = require(Gameplay.CooldownService)
local DeathService = require(Gameplay.DeathService)
local DownedService = require(Gameplay.DownedService)
local GameService = require(Gameplay.GameService)
local LobbyService = require(Gameplay.LobbyService)
local MatchService = require(Gameplay.MatchService)
local RespawnService = require(Gameplay.RespawnService)  -- âœ… NEW

-- Player Services
print("[Init] Loading Player services...")
local PlayerStateService = require(Player.PlayerStateService)

-- Data Services (NEW)
print("[Init] Loading Data services...")
local PlayerDataService = require(Data.PlayerDataService)

-- Cloud Services (NEW)
print("[Init] Loading Cloud services...")
local PocketBaseService = require(Cloud.PocketBaseService)

local TestService = require(Services.TestService)

-- Utils
print("[Init] Loading Utils...")
local IdempotentGuard = require(Utils.IdempotentGuard)
local ServiceLocator = require(Utils.ServiceLocator)
local DataMapper = require(Utils.DataMapper)
local IdempotencyKey = require(Utils.IdempotencyKey)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- HELPER FUNCTIONS (NOW TIMEOUTS IS AVAILABLE!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

--[[]
    Initialize a single service with error handling + timeout
    @param service table - Service instance
    @param name string - Service name for logging
    @param timeout number? - Timeout in seconds
    @return Promise<boolean>
]]
local function initService(service: any, name: string, timeout: number?): any
	timeout = timeout or TIMEOUTS.ServiceInit  -- âœ… à¸•à¸­à¸™à¸™à¸µà¹‰ TIMEOUTS à¸¡à¸µà¸„à¹ˆà¸²à¹à¸¥à¹‰à¸§!
	
	return Promise.new(function(resolve, reject)
		local success, err = pcall(function()
			if service and type(service.Init) == "function" then
				service:Init()
			end
		end)
		
		if success then
			print(`[Init] âœ… {name} initialized`)
			resolve(true)
		else
			reject(`{name} failed: {err}`)
		end
	end)
		:timeout(timeout)
		:catch(function(err)
			if Promise.Error.isKind(err, Promise.Error.Kind.TimedOut) then
				error(`[Init] â±ï¸ TIMEOUT: {name} Init exceeded {timeout}s`)
			else
				error(`[Init] âŒ ERROR: {name} Init failed: {err}`)
			end
		end)
end

--[[]
    Start a single service with error handling + timeout
    @param service table - Service instance
    @param name string - Service name for logging
    @param timeout number? - Timeout in seconds
    @return Promise<boolean>
]]
local function startService(service: any, name: string, timeout: number?): any
	timeout = timeout or TIMEOUTS.ServiceStart  -- âœ… à¸•à¸­à¸™à¸™à¸µà¹‰ TIMEOUTS à¸¡à¸µà¸„à¹ˆà¸²à¹à¸¥à¹‰à¸§!
	
	return Promise.new(function(resolve, reject)
		local success, err = pcall(function()
			if service and type(service.Start) == "function" then
				service:Start()
			end
		end)
		
		if success then
			print(`[Init] âœ… {name} started`)
			resolve(true)
		else
			reject(`{name} failed: {err}`)
		end
	end)
		:timeout(timeout)
		:catch(function(err)
			if Promise.Error.isKind(err, Promise.Error.Kind.TimedOut) then
				error(`[Init] â±ï¸ TIMEOUT: {name} Start exceeded {timeout}s`)
			else
				error(`[Init] âŒ ERROR: {name} Start failed: {err}`)
			end
		end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- INITIALIZE SERVICES (WITH TIMEOUTS)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] ğŸ”§ Initializing services...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

local layerTimes: {[string]: number} = {}

Promise.resolve()

	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- 0ï¸âƒ£ REGISTER SERVICES IN LOCATOR
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	:andThen(function()
		print("\n[Init] ğŸ“‹ Registering services in ServiceLocator...")
		
		ServiceLocator:Register("NetworkHandler", NetworkHandler)
		ServiceLocator:Register("CmdrService", CmdrService)  -- âœ… à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
		ServiceLocator:Register("PocketBaseService", PocketBaseService)
		ServiceLocator:Register("PlayerDataService", PlayerDataService)
		ServiceLocator:Register("PlayerStateService", PlayerStateService)
		ServiceLocator:Register("LobbyService", LobbyService)
		ServiceLocator:Register("ArenaService", ArenaService)
		ServiceLocator:Register("CombatService", CombatService)
		ServiceLocator:Register("DeathService", DeathService)
		ServiceLocator:Register("DownedService", DownedService)
		ServiceLocator:Register("RespawnService", RespawnService)
		ServiceLocator:Register("MatchService", MatchService)
		ServiceLocator:Register("CooldownService", CooldownService)
		ServiceLocator:Register("GameService", GameService)
		
		print("[Init] âœ… All services registered")
	end)
	-- 1ï¸âƒ£ Core Layer
	:andThen(function()
		print("[Init] 1ï¸âƒ£ Core Layer...")
		local startTime = os.clock()
		
		return Promise.all({
			initService(NetworkHandler, "NetworkHandler"),
			initService(CmdrService, "CmdrService"),  -- âœ… à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
		})
			:andThen(function()
				layerTimes["Core"] = os.clock() - startTime
			end)
			:timeout(TIMEOUTS.LayerInit)
	end)	
	-- 2ï¸âƒ£ Cloud Layer
	:andThen(function()
		print("[Init] 2ï¸âƒ£ Cloud Layer...")
		local startTime = os.clock()
		
		return initService(PocketBaseService, "PocketBaseService")
			:andThen(function()
				layerTimes["Cloud"] = os.clock() - startTime
			end)
			:timeout(TIMEOUTS.LayerInit)
	end)
	
	-- 3ï¸âƒ£ Data Layer
	:andThen(function()
		print("[Init] 3ï¸âƒ£ Data Layer...")
		local startTime = os.clock()
		
		return initService(PlayerDataService, "PlayerDataService")
			:andThen(function()
				layerTimes["Data"] = os.clock() - startTime
			end)
			:timeout(TIMEOUTS.LayerInit)
	end)
	
	-- 4ï¸âƒ£ Player Layer
	:andThen(function()
		print("[Init] 4ï¸âƒ£ Player Layer...")
		local startTime = os.clock()
		
		return initService(PlayerStateService, "PlayerStateService")
			:andThen(function()
				layerTimes["Player"] = os.clock() - startTime
			end)
			:timeout(TIMEOUTS.LayerInit)
	end)
	
	-- 5ï¸âƒ£ Gameplay Layer (PARALLEL)
	:andThen(function()
		print("[Init] 5ï¸âƒ£ Gameplay Layer (Parallel)...")
		local startTime = os.clock()
		
		return Promise.all({
			initService(LobbyService, "LobbyService"),
			initService(ArenaService, "ArenaService"),
			initService(CombatService, "CombatService"),
			initService(DeathService, "DeathService"),
			initService(DownedService, "DownedService"),
			initService(RespawnService, "RespawnService"),
			initService(MatchService, "MatchService"),
			initService(CooldownService, "CooldownService"),
			initService(GameService, "GameService"),
		})
			:andThen(function()
				layerTimes["Gameplay"] = os.clock() - startTime
				print(`[Init] âš¡ Gameplay Layer completed in {string.format("%.3f", layerTimes["Gameplay"])}s (Parallel)`)
			end)
			:timeout(TIMEOUTS.LayerInit)
	end)
	
	-- 6ï¸âƒ£ Test Layer (optional)
	:andThen(function()
		print("[Init] 6ï¸âƒ£ Test Layer...")
		local startTime = os.clock()
		
		return initService(TestService, "TestService")
			:andThen(function()
				layerTimes["Test"] = os.clock() - startTime
			end)
			:timeout(TIMEOUTS.LayerInit)
			:catch(function(err)
				warn(`[Init] âš ï¸ Test Layer failed: {err}`)
				return Promise.resolve()
			end)
	end)
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- START SERVICES (WITH TIMEOUTS)
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	:andThen(function()
		print("\n[Init] â–¶ï¸ Starting services...")
		print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
		return Promise.resolve()
	end)
	
	:andThen(function()
		return Promise.all({
			startService(NetworkHandler, "NetworkHandler"),
			startService(CmdrService, "CmdrService"),  -- âœ… à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
		}):timeout(TIMEOUTS.LayerStart)
	end)
	
	:andThen(function()
		return Promise.all({
			startService(PocketBaseService, "PocketBaseService"),
			startService(PlayerDataService, "PlayerDataService"),
		}):timeout(TIMEOUTS.LayerStart)
	end)
	
	:andThen(function()
		return startService(PlayerStateService, "PlayerStateService")
			:timeout(TIMEOUTS.LayerStart)
	end)
	
	:andThen(function()
		return Promise.all({
			startService(LobbyService, "LobbyService"),
			startService(ArenaService, "ArenaService"),
			startService(CombatService, "CombatService"),
			startService(DeathService, "DeathService"),
			startService(DownedService, "DownedService"),
			startService(RespawnService, "RespawnService"),
			startService(MatchService, "MatchService"),
			startService(CooldownService, "CooldownService"),
			startService(GameService, "GameService"),
		}):timeout(TIMEOUTS.LayerStart)
	end)
	
	:andThen(function()
		return startService(TestService, "TestService")
			:timeout(TIMEOUTS.LayerStart)
			:catch(function(err)
				warn(`[Init] âš ï¸ TestService start failed: {err}`)
				return Promise.resolve()
			end)
	end)
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- FINALIZE
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	:andThen(function()
		_G.__SERVER_INITIALIZED = true
		_G.__SERVER_INIT_TIME = bootStartTime
		
		local bootTime = os.clock() - bootStartTime
		
		print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
		print("âœ… All services initialized and started successfully.")
		print(string.format("â±ï¸ Total boot time: %.3fs", bootTime))
		print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
		
		-- Print layer breakdown
		print("\nğŸ“Š Layer Timing Breakdown:")
		print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
		for layer, time in pairs(layerTimes) do
			local percentage = (time / bootTime) * 100
			print(string.format("  %s: %.3fs (%.1f%%)", layer, time, percentage))
		end
		print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
		
		-- Print summaries
		if IdempotentGuard and IdempotentGuard.printSummary then
			IdempotentGuard.printSummary()
		end
		
		ServiceLocator:PrintRegistry()
		DataMapper.PrintSchemas()
	end)
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- ERROR HANDLING
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	:catch(function(err)
		error(`[Init] âŒ CRITICAL ERROR during boot: {err}`)
		
		-- Optionally: Attempt graceful shutdown
		-- for _, player in ipairs(Players:GetPlayers()) do
		-- 	player:Kick("Server failed to start. Please rejoin.")
		-- end
	end)
	
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	-- FINALLY (always runs)
	-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	
	:finally(function()
		print(`\nâ±ï¸  Boot completed at: {os.date("%X", os.time())}`)
		
		-- Expose for debugging (only in Studio)
		if game:GetService("RunService"):IsStudio() then
			_G.Services = {
				NetworkHandler = NetworkHandler,
				CmdrService = CmdrService,  -- âœ… à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
				
				-- Data
				PlayerDataService = PlayerDataService,
				
				-- Player
				PlayerStateService = PlayerStateService,
				
				-- Gameplay
				ArenaService = ArenaService,
				CombatService = CombatService,
				CooldownService = CooldownService,
				DeathService = DeathService,
				DownedService = DownedService,
				GameService = GameService,
				LobbyService = LobbyService,
				MatchService = MatchService,
				RespawnService = RespawnService,
				
				-- Cloud
				PocketBaseService = PocketBaseService,
				
				-- Test
				TestService = TestService,
			}
			
			-- âœ… Add new utilities
			_G.ServiceLocator = ServiceLocator
			_G.DataMapper = DataMapper
			_G.IdempotencyKey = IdempotencyKey
			_G.Promise = Promise
			
			if IdempotentGuard then
				_G.IdempotentGuard = IdempotentGuard
			end
			
			print("[Init] ğŸ” Debug mode: _G.Services exposed")
		end
	end)