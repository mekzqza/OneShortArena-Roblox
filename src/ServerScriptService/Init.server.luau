--!strict

local ServerScriptService = game:GetService("ServerScriptService")
local ServerStorage = game:GetService("ServerStorage")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- IDEMPOTENT GUARD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if _G.__SERVER_INITIALIZED then
	warn("[Init.server] âš ï¸ Server already initialized! Skipping re-initialization.")
	return
end

print("ğŸ”Œ Server Init: Starting Services...")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GET FOLDERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Services = ServerScriptService:WaitForChild("Services")
local Utils = ServerScriptService:WaitForChild("Utils")

-- âœ… NEW: Services subfolders
local Core = Services:WaitForChild("Core")
local Gameplay = Services:WaitForChild("Gameplay")
local Player = Services:WaitForChild("Player")
local Data = Services:WaitForChild("Data")
local Cloud = Services:WaitForChild("Cloud")

-- âœ… Preload NetworkConfig
local Configs = ServerStorage:WaitForChild("Configs")
local NetworkConfig = require(Configs.NetworkConfig)

print("[Init] ğŸ“¡ Loaded NetworkConfig")
NetworkConfig.PrintSummary()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD SERVICES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Core Services
print("[Init] Loading Core services...")
local NetworkHandler = require(Core.NetworkHandler)

-- Gameplay Services
print("[Init] Loading Gameplay services...")
local ArenaService = require(Gameplay.ArenaService)
local CombatService = require(Gameplay.CombatService)    -- âœ… NEW
local CooldownService = require(Gameplay.CooldownService)
local DeathService = require(Gameplay.DeathService)
local DownedService = require(Gameplay.DownedService)
local GameService = require(Gameplay.GameService)
local LobbyService = require(Gameplay.LobbyService)
local MatchService = require(Gameplay.MatchService)
local RespawnService = require(Gameplay.RespawnService)  -- âœ… NEW

-- Player Services
print("[Init] Loading Player services...")
local PlayerStateService = require(Player.PlayerStateService)

-- Data Services (NEW)
print("[Init] Loading Data services...")
local PlayerDataService = require(Data.PlayerDataService)

-- Cloud Services (NEW)
print("[Init] Loading Cloud services...")
local PocketBaseService = require(Cloud.PocketBaseService)

local TestService = require(Services.TestService)

-- Utils
print("[Init] Loading Utils...")
local IdempotentGuard = require(Utils.IdempotentGuard)
local ServiceLocator = require(Utils.ServiceLocator)
local DataMapper = require(Utils.DataMapper)
local IdempotencyKey = require(Utils.IdempotencyKey)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- INITIALIZE SERVICES (DEPENDENCY ORDER)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] ğŸ”§ Initializing services...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- 1. Core Services (no dependencies)
print("[Init] 1ï¸âƒ£ Core Layer...")
NetworkHandler:Init()

-- 2. Cloud Services (depend on Core, before Data)
print("[Init] 2ï¸âƒ£ Cloud Layer...")
PocketBaseService:Init()

-- 3. Data Services (depend on Cloud)
print("[Init] 3ï¸âƒ£ Data Layer...")
PlayerDataService:Init()

-- 4. Player Services (depend on Data)
print("[Init] 4ï¸âƒ£ Player Layer...")
PlayerStateService:Init()


-- 5. Gameplay Services (depend on Player)
print("[Init] 5ï¸âƒ£ Gameplay Layer...")
LobbyService:Init()
ArenaService:Init()
CombatService:Init()
DeathService:Init()
DownedService:Init()
RespawnService:Init()
MatchService:Init()
CooldownService:Init()
GameService:Init()

-- 6. Test/Debug Services (optional, last)
print("[Init] 6ï¸âƒ£ Test Layer...")
TestService:Init()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- REGISTER SERVICES IN LOCATOR (after Init, before Start)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] ğŸ“‹ Registering services in ServiceLocator...")

ServiceLocator:Register("NetworkHandler", NetworkHandler)
ServiceLocator:Register("PocketBaseService", PocketBaseService)
ServiceLocator:Register("PlayerDataService", PlayerDataService)
ServiceLocator:Register("PlayerStateService", PlayerStateService)
ServiceLocator:Register("LobbyService", LobbyService)
ServiceLocator:Register("ArenaService", ArenaService)
ServiceLocator:Register("CombatService", CombatService)
ServiceLocator:Register("DeathService", DeathService)
ServiceLocator:Register("DownedService", DownedService)
ServiceLocator:Register("RespawnService", RespawnService)
ServiceLocator:Register("MatchService", MatchService)
ServiceLocator:Register("CooldownService", CooldownService)
ServiceLocator:Register("GameService", GameService)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- START SERVICES (RUNTIME PHASE)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] â–¶ï¸ Starting services...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- Start in same order as Init
NetworkHandler:Start()

PocketBaseService:Start()
PlayerDataService:Start()
PlayerStateService:Start()


LobbyService:Start()
ArenaService:Start()
CombatService:Start()   -- âœ… NEW
DeathService:Start()
DownedService:Start()
RespawnService:Start()  -- âœ… NEW
MatchService:Start()
CooldownService:Start()
GameService:Start()

TestService:Start()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FINALIZE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_G.__SERVER_INITIALIZED = true
_G.__SERVER_INIT_TIME = os.clock()

print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… All services initialized and started successfully.")
print(string.format("â±ï¸ Total time: %.3fs", os.clock() - (_G.__SERVER_INIT_TIME or 0)))
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

-- âœ… Print summaries
if IdempotentGuard and IdempotentGuard.printSummary then
	IdempotentGuard.printSummary()
end

ServiceLocator:PrintRegistry()
DataMapper.PrintSchemas()

-- Expose for debugging (only in Studio)
if game:GetService("RunService"):IsStudio() then
	_G.Services = {
		-- Core
		NetworkHandler = NetworkHandler,
		
		-- Data
		PlayerDataService = PlayerDataService,  -- âœ… NEW
		
		-- Player
		PlayerStateService = PlayerStateService,
		
		-- Gameplay
		ArenaService = ArenaService,
		CombatService = CombatService,     -- âœ… NEW
		CooldownService = CooldownService,
		DeathService = DeathService,
		DownedService = DownedService,
		GameService = GameService,
		LobbyService = LobbyService,
		MatchService = MatchService,
		RespawnService = RespawnService,   -- âœ… NEW
		
		-- Cloud
		PocketBaseService = PocketBaseService,  -- âœ… NEW
		
		-- Test
		TestService = TestService,
	}
	
	-- âœ… Add new utilities
	_G.ServiceLocator = ServiceLocator
	_G.DataMapper = DataMapper
	_G.IdempotencyKey = IdempotencyKey
	
	if IdempotentGuard then
		_G.IdempotentGuard = IdempotentGuard
	end
	
	print("[Init] ğŸ” Debug mode: _G.Services exposed")
end