--!strict

local ServerScriptService = game:GetService("ServerScriptService")
local ServerStorage = game:GetService("ServerStorage")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- IDEMPOTENT GUARD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if _G.__SERVER_INITIALIZED then
    warn("[Init.server] âš ï¸ Server already initialized! Skipping re-initialization.")
    return
end

print("ğŸ”Œ Server Init: Starting Services...")

-- Get Services folder
local Services = ServerScriptService:WaitForChild("Services")
local utils = ServerScriptService:WaitForChild("Utils")

-- âœ… Preload NetworkConfig
local Configs = ServerStorage:WaitForChild("Configs")
local NetworkConfig = require(Configs.NetworkConfig)

print("[Init] ğŸ“¡ Loaded NetworkConfig")
NetworkConfig.PrintSummary()

-- Load core services in dependency order
local NetworkHandler = require(Services.NetworkHandler)
local LobbyService = require(Services.LobbyService)
local ArenaService = require(Services.ArenaService)
local PlayerStateService = require(Services.PlayerStateService)
local DeathService = require(Services.DeathService)
local MatchService = require(Services.MatchService)  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
local GameService = require(Services.GameService)
local TestService = require(Services.TestService)

--load utils for idempotent guard service
local IdempotentGuard  = require(utils.IdempotentGuard)


-- Initialize core services
print("[Init] Initializing NetworkHandler...")
NetworkHandler:Init()

print("[Init] Initializing LobbyService...")
LobbyService:Init()

print("[Init] Initializing ArenaService...")  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
ArenaService:Init()

print("[Init] Initializing PlayerStateService...")
PlayerStateService:Init()

print("[Init] Initializing DeathService...")  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
DeathService:Init()

print("[Init] Initializing MatchService...")  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
MatchService:Init()

print("[Init] Initializing GameService...")
GameService:Init()

print("[Init] Initializing TestService...")
TestService:Init()

-- Start services (runtime phase)
print("[Init] Starting services...")
NetworkHandler:Start()
LobbyService:Start()
ArenaService:Start()  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
PlayerStateService:Start()
DeathService:Start()  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
MatchService:Start()  -- âœ… à¹€à¸à¸´à¹ˆà¸¡
GameService:Start()
TestService:Start()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FINALIZE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_G.__SERVER_INITIALIZED = true
_G.__SERVER_INIT_TIME = os.clock()

print("âœ… All services initialized and started successfully.")

-- âœ… Print IdempotentGuard summary (if available)
if IdempotentGuard and IdempotentGuard.printSummary then
    IdempotentGuard.printSummary()
end

-- Expose for debugging (only in Studio)
if game:GetService("RunService"):IsStudio() then
    if IdempotentGuard then
        _G.IdempotentGuard = IdempotentGuard
    end
end