--!strict

local ServerScriptService = game:GetService("ServerScriptService")
local ServerStorage = game:GetService("ServerStorage")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- IDEMPOTENT GUARD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if _G.__SERVER_INITIALIZED then
	warn("[Init.server] âš ï¸ Server already initialized! Skipping re-initialization.")
	return
end

print("ğŸ”Œ Server Init: Starting Services...")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GET FOLDERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Services = ServerScriptService:WaitForChild("Services")
local Utils = ServerScriptService:WaitForChild("Utils")

-- âœ… NEW: Services subfolders
local Core = Services:WaitForChild("Core")
local Gameplay = Services:WaitForChild("Gameplay")
local Player = Services:WaitForChild("Player")

-- âœ… Preload NetworkConfig
local Configs = ServerStorage:WaitForChild("Configs")
local NetworkConfig = require(Configs.NetworkConfig)

print("[Init] ğŸ“¡ Loaded NetworkConfig")
NetworkConfig.PrintSummary()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD SERVICES (NEW STRUCTURE)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Core Services
print("[Init] Loading Core services...")
local NetworkHandler = require(Core.NetworkHandler)

-- Gameplay Services
print("[Init] Loading Gameplay services...")
local ArenaService = require(Gameplay.ArenaService)
local CooldownService = require(Gameplay.CooldownService)
local DeathService = require(Gameplay.DeathService)
local GameService = require(Gameplay.GameService)
local LobbyService = require(Gameplay.LobbyService)
local MatchService = require(Gameplay.MatchService)

-- Player Services
print("[Init] Loading Player services...")
local PlayerStateService = require(Player.PlayerStateService)

local TestService = require(Services.TestService)

-- Utils
print("[Init] Loading Utils...")
local IdempotentGuard = require(Utils.IdempotentGuard)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- INITIALIZE SERVICES (DEPENDENCY ORDER)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] ğŸ”§ Initializing services...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- 1. Core Services (no dependencies)
print("[Init] 1ï¸âƒ£ Core Layer...")
NetworkHandler:Init()

-- 2. Player Services (depend on Core)
print("[Init] 2ï¸âƒ£ Player Layer...")
PlayerStateService:Init()


-- 3. Gameplay Services (depend on Player)
print("[Init] 3ï¸âƒ£ Gameplay Layer...")
LobbyService:Init()
ArenaService:Init()
DeathService:Init()
MatchService:Init()
CooldownService:Init()
GameService:Init()

-- 4. Test/Debug Services (optional, last)
print("[Init] 4ï¸âƒ£ Test Layer...")
TestService:Init()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- START SERVICES (RUNTIME PHASE)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("\n[Init] â–¶ï¸ Starting services...")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- Start in same order as Init
NetworkHandler:Start()

PlayerStateService:Start()


LobbyService:Start()
ArenaService:Start()
DeathService:Start()
MatchService:Start()
CooldownService:Start()
GameService:Start()

TestService:Start()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FINALIZE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

_G.__SERVER_INITIALIZED = true
_G.__SERVER_INIT_TIME = os.clock()

print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… All services initialized and started successfully.")
print(string.format("â±ï¸ Total time: %.3fs", os.clock() - (_G.__SERVER_INIT_TIME or 0)))
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

-- âœ… Print IdempotentGuard summary (if available)
if IdempotentGuard and IdempotentGuard.printSummary then
	IdempotentGuard.printSummary()
end

-- Expose for debugging (only in Studio)
if game:GetService("RunService"):IsStudio() then
	_G.Services = {
		-- Core
		NetworkHandler = NetworkHandler,
		
		-- Player
		PlayerStateService = PlayerStateService,
		
		-- Gameplay
		ArenaService = ArenaService,
		CooldownService = CooldownService,
		DeathService = DeathService,
		GameService = GameService,
		LobbyService = LobbyService,
		MatchService = MatchService,
		
		-- Test
		TestService = TestService,
	}
	
	if IdempotentGuard then
		_G.IdempotentGuard = IdempotentGuard
	end
	
	print("[Init] ğŸ” Debug mode: _G.Services exposed")
end