--!strict
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö EventBus ‡πÅ‡∏•‡∏∞ Events ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local Events = require(ReplicatedStorage.Shared.Events)

local GameService = {}

-- ============================================================================
-- ‚öôÔ∏è Config (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°)
-- ============================================================================
local CONFIG = {
	MIN_PLAYERS = 1,        -- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏ï‡∏±‡πâ‡∏á 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
	WAIT_TIME = 10,         -- ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÉ‡∏ô Lobby (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
	INTERMISSION = 5        -- ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏°
}

-- ============================================================================
-- üìä State (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
-- ============================================================================
local isMatchActive = false
local lobbyTimer = CONFIG.WAIT_TIME

--[[\
	Init: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô Server ‡πÄ‡∏£‡∏¥‡πà‡∏°
	‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
--]]
function GameService:Init()
	print("üèóÔ∏è GameService: Initializing...")
	
	if not Workspace:FindFirstChild("Spawns") then
		local folder = Instance.new("Folder")
		folder.Name = "Spawns"
		folder.Parent = Workspace
		warn("‚ö†Ô∏è Auto-created 'Spawns' folder. Please add 'LobbySpawn' inside it!")
	end
end

--[[\
	Start: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
	‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Event ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° Game Loop
--]]
function GameService:Start()
	print("üèÅ GameService: Lobby System Started")

	-- 1. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° -> ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà Lobby
	Players.PlayerAdded:Connect(function(player)
		self:OnPlayerJoin(player)
	end)

	-- 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏Å‡∏° -> ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
	Players.PlayerRemoving:Connect(function(player)
		EventBus:Emit(Events.PLAYER_LEFT, player)
	end)
	
	-- 3. ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏à‡∏≤‡∏Å ArenaService ‡∏´‡∏£‡∏∑‡∏≠ Admin)
	EventBus:On(Events.GAME_ENDED, function()
		self:EndMatch()
	end)

	-- 4. ‡∏£‡∏±‡∏ô‡∏•‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô Thread ‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
	task.spawn(function()
		while true do
			self:GameLoop()
			task.wait(1) -- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
		end
	end)
end

--[[\
	OnPlayerJoin: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
	‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î LobbySpawn ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
--]]
function GameService:OnPlayerJoin(player: Player)
	print("üëã " .. player.Name .. " joined the lobby.")
	
	-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î Lobby
	local spawns = Workspace:FindFirstChild("Spawns")
	local lobbySpawn = spawns and spawns:FindFirstChild("LobbySpawn")
	
	if lobbySpawn and lobbySpawn:IsA("SpawnLocation") then
		player.RespawnLocation = lobbySpawn -- ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏ñ‡∏≤‡∏ß‡∏£
	else
		warn("‚ö†Ô∏è CRITICAL: 'LobbySpawn' not found in Workspace/Spawns!")
	end
	
	-- ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
	player:LoadCharacter()
	
	-- ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
	EventBus:Emit(Events.PLAYER_JOINED, player)
end

--[[\
	GameLoop: ‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°
	‡∏Ñ‡∏≠‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
--]]
function GameService:GameLoop()
	-- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Arena) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô Lobby Loop
	if isMatchActive then return end

	local playerCount = #Players:GetPlayers()

	-- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
	if playerCount >= CONFIG.MIN_PLAYERS then
		-- ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö! ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
		lobbyTimer -= 1
		
		-- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô "Starting in 5...")
		-- ‡πÉ‡∏ä‡πâ Events.UI_SHOW_NOTIFICATION ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
		if lobbyTimer <= 5 or lobbyTimer % 5 == 0 then
			EventBus:Emit(Events.UI_SHOW_NOTIFICATION, "Match starts in: " .. lobbyTimer)
			print("‚è≥ Lobby Countdown: " .. lobbyTimer)
		end

		-- ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î -> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!
		if lobbyTimer <= 0 then
			self:StartMatch()
		end
	else
		-- ‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ -> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
		if lobbyTimer ~= CONFIG.WAIT_TIME then
			lobbyTimer = CONFIG.WAIT_TIME
			EventBus:Emit(Events.UI_SHOW_NOTIFICATION, "Waiting for players...")
			print("‚ùå Not enough players. Timer reset.")
		end
	end
end

--[[\
	StartMatch: ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå
--]]
function GameService:StartMatch()
	print("üöÄ STARTING MATCH!")
	isMatchActive = true
	
	-- ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì "GAME_STARTED"
	-- ArenaService ‡∏à‡∏∞‡∏£‡∏±‡∏ö Event ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏£‡πå‡∏õ‡∏Ñ‡∏ô‡πÑ‡∏õ‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
	EventBus:Emit(Events.GAME_STARTED)
end

--[[\
	EndMatch: ‡∏à‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå (‡∏û‡∏±‡∏Å‡∏¢‡∏Å)
--]]
function GameService:EndMatch()
	print("üõë Match Ended. Cooldown before lobby...")
	task.wait(CONFIG.INTERMISSION)
	
	isMatchActive = false
	lobbyTimer = CONFIG.WAIT_TIME
	print("üîÑ Back to Lobby Loop")
end

return GameService